name: æ™ºèƒ½è¯•å·ç”Ÿæˆç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰

on:
  schedule:
    - cron: '0 8 * * 0'  # æ¯å‘¨æ—¥ä¸Šåˆ8ç‚¹
  workflow_dispatch:
    inputs:
      exam_type:
        description: 'è¯•å·ç±»å‹'
        required: true
        type: choice
        options:
          - å•å…ƒæµ‹è¯•
          - æœŸä¸­è€ƒè¯•
          - æœŸæœ«è€ƒè¯•
          - éšæœºç»ƒä¹ 
          - è‡ªé€‚åº”æµ‹è¯•
        default: 'å•å…ƒæµ‹è¯•'
      course:
        description: 'è¯¾ç¨‹ç« èŠ‚'
        required: true
        type: choice
        options:
          - å…¨éƒ¨ç« èŠ‚
          - ç¬¬ä¸€ç«  å‡½æ•°ä¸æé™
          - ç¬¬äºŒç«  å¯¼æ•°ä¸å¾®åˆ†
          - ç¬¬ä¸‰ç«  ç§¯åˆ†
          - ç¬¬å››ç«  å¤šå…ƒå‡½æ•°
          - ç¬¬äº”ç«  çº§æ•°
        default: 'å…¨éƒ¨ç« èŠ‚'
      question_count:
        description: 'é¢˜ç›®æ•°é‡'
        required: true
        type: number
        default: 10
      difficulty:
        description: 'éš¾åº¦ç­‰çº§ (1-5)'
        required: true
        type: number
        default: 3
      adaptive_mode:
        description: 'è‡ªé€‚åº”æ¨¡å¼ï¼ˆæ ¹æ®å­¦ç”Ÿæ°´å¹³è°ƒæ•´ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: read

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pygithub requests numpy
          
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: mkdir -p data/exams data/exam_history data/student_results
      
      - name: è¿è¡Œå¢å¼ºè¯•å·ç”Ÿæˆè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          EXAM_TYPE: ${{ github.event.inputs.exam_type || 'å•å…ƒæµ‹è¯•' }}
          COURSE: ${{ github.event.inputs.course || 'å…¨éƒ¨ç« èŠ‚' }}
          QUESTION_COUNT: ${{ github.event.inputs.question_count || 10 }}
          DIFFICULTY: ${{ github.event.inputs.difficulty || 3 }}
          ADAPTIVE_MODE: ${{ github.event.inputs.adaptive_mode || false }}
        run: |
          python << 'EOF'
          import json
          import os
          import random
          from datetime import datetime
          from github import Github
          
          # åˆå§‹åŒ–
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          g = Github(token)
          repo = g.get_repo(repo_name)
          
          # è·å–è¾“å…¥å‚æ•°
          exam_type = os.environ.get('EXAM_TYPE', 'å•å…ƒæµ‹è¯•')
          course = os.environ.get('COURSE', 'å…¨éƒ¨ç« èŠ‚')
          question_count = int(os.environ.get('QUESTION_COUNT', 10))
          target_difficulty = int(os.environ.get('DIFFICULTY', 3))
          adaptive_mode = os.environ.get('ADAPTIVE_MODE', 'false').lower() == 'true'
          
          print(f"ğŸ“ å¼€å§‹ç”Ÿæˆ{exam_type}è¯•å·...")
          print(f"   è¯¾ç¨‹: {course}")
          print(f"   é¢˜ç›®æ•°é‡: {question_count}")
          print(f"   ç›®æ ‡éš¾åº¦: {target_difficulty}")
          print(f"   è‡ªé€‚åº”æ¨¡å¼: {adaptive_mode}")
          
          # å¢å¼ºç‰ˆæ•°å­¦é¢˜åº“
          enhanced_question_bank = {
              'ç¬¬ä¸€ç«  å‡½æ•°ä¸æé™': [
                  {
                      'id': 'M1-001',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'æé™å®šä¹‰',
                      'content': r'è®¡ç®—æé™ï¼š$$\lim_{x\to 0} \frac{\sin 3x}{x}$$',
                      'options': ['0', '1', '3', 'âˆ'],
                      'answer': 2,
                      'explanation': r'ä½¿ç”¨é‡è¦æé™å…¬å¼ï¼š$\lim_{x\to 0} \frac{\sin ax}{x} = a$ï¼Œæ‰€ä»¥ç»“æœä¸º3',
                      'difficulty': 1,
                      'points': 5,
                      'estimated_time': 3,
                      'tags': ['åŸºç¡€', 'é‡è¦æé™']
                  },
                  {
                      'id': 'M1-002',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'è¿ç»­æ€§',
                      'content': r'å‡½æ•° $f(x) = \begin{cases} x^2, & x \neq 1 \\ a, & x = 1 \end{cases}$ åœ¨ $x=1$ å¤„è¿ç»­ï¼Œåˆ™ $a=$',
                      'options': ['0', '1', '2', 'ä¸å­˜åœ¨'],
                      'answer': 1,
                      'explanation': r'è¿ç»­è¦æ±‚ $\lim_{x\to 1} f(x) = f(1)$ï¼Œå³ $\lim_{x\to 1} x^2 = a$ï¼Œæ‰€ä»¥ $a=1$',
                      'difficulty': 2,
                      'points': 5,
                      'estimated_time': 5,
                      'tags': ['è¿ç»­æ€§', 'åˆ†æ®µå‡½æ•°']
                  },
                  {
                      'id': 'M1-003',
                      'type': 'å¤šé€‰é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'æé™æ€§è´¨',
                      'content': r'ä¸‹åˆ—æé™è®¡ç®—æ­£ç¡®çš„æœ‰ï¼š',
                      'options': [
                          r'$\lim_{x\to 0} \frac{\tan x}{x} = 1$',
                          r'$\lim_{x\to \infty} \frac{1}{x} = 0$',
                          r'$\lim_{x\to 0} \frac{1-\cos x}{x^2} = \frac{1}{2}$',
                          r'$\lim_{x\to \infty} (1+\frac{1}{x})^x = 1$'
                      ],
                      'answer': [0, 1, 2],
                      'explanation': r'Aã€Bã€Cæ­£ç¡®ï¼ŒDåº”ä¸º$e$',
                      'difficulty': 3,
                      'points': 8,
                      'estimated_time': 8,
                      'tags': ['æé™', 'é‡è¦å…¬å¼']
                  },
                  {
                      'id': 'M1-004',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'ä¸å®šå¼æé™',
                      'content': r'è®¡ç®—æé™ï¼š$$\lim_{x\to 0} \frac{e^x - 1 - x}{x^2}$$',
                      'answer': r'$\frac{1}{2}$',
                      'explanation': r'ä½¿ç”¨æ³°å‹’å±•å¼€æˆ–æ´›å¿…è¾¾æ³•åˆ™ï¼Œ$e^x = 1 + x + \frac{x^2}{2} + o(x^2)$ï¼Œä»£å…¥å¾— $\frac{1}{2}$',
                      'difficulty': 4,
                      'points': 12,
                      'estimated_time': 15,
                      'tags': ['æ³°å‹’å±•å¼€', 'æ´›å¿…è¾¾æ³•åˆ™']
                  },
                  {
                      'id': 'M1-005',
                      'type': 'è¯æ˜é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'æé™å­˜åœ¨å‡†åˆ™',
                      'content': r'è¯æ˜ï¼š$\lim_{n\to \infty} n\sin\frac{1}{n} = 1$',
                      'answer': r'ä½¿ç”¨å¤¹é€¼å‡†åˆ™ï¼š$\cos\frac{1}{n} < n\sin\frac{1}{n} < 1$ï¼Œä¸¤è¾¹æé™å‡ä¸º1',
                      'explanation': r'åˆ©ç”¨ä¸ç­‰å¼ $\cos x < \frac{\sin x}{x} < 1$ï¼ˆ$x>0$ï¼‰ï¼Œä»¤$x=\frac{1}{n}$ï¼Œå¤¹é€¼å¾—è¯',
                      'difficulty': 4,
                      'points': 15,
                      'estimated_time': 20,
                      'tags': ['è¯æ˜', 'å¤¹é€¼å‡†åˆ™']
                  },
                  {
                      'id': 'M1-006',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬ä¸€ç« ',
                      'knowledge_point': 'ç­‰ä»·æ— ç©·å°',
                      'content': r'è®¡ç®—æé™ï¼š$$\lim_{x\to 0} \frac{\sqrt{1+x} - 1}{\sin x}$$',
                      'answer': r'$\frac{1}{2}$',
                      'explanation': r'åˆ†å­æœ‰ç†åŒ–ï¼š$\frac{x}{\sqrt{1+x} + 1}$ï¼Œåˆ†æ¯ç”¨ç­‰ä»·æ— ç©·å°$\sin x \sim x$ï¼Œå¾—$\frac{1}{2}$',
                      'difficulty': 2,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['ç­‰ä»·æ— ç©·å°', 'åˆ†å­æœ‰ç†åŒ–']
                  }
              ],
              'ç¬¬äºŒç«  å¯¼æ•°ä¸å¾®åˆ†': [
                  {
                      'id': 'M2-001',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬äºŒç« ',
                      'knowledge_point': 'å¯¼æ•°å®šä¹‰',
                      'content': r'å‡½æ•° $f(x) = |x|$ åœ¨ $x=0$ å¤„',
                      'options': ['å¯å¯¼ä¸”å¯¼æ•°ä¸º0', 'å¯å¯¼ä¸”å¯¼æ•°ä¸º1', 'ä¸å¯å¯¼', 'å¯¼æ•°ä¸ºæ— ç©·'],
                      'answer': 2,
                      'explanation': r'å·¦å¯¼æ•°ä¸º-1ï¼Œå³å¯¼æ•°ä¸º1ï¼Œä¸ç›¸ç­‰ï¼Œæ•…ä¸å¯å¯¼',
                      'difficulty': 2,
                      'points': 5,
                      'estimated_time': 5,
                      'tags': ['å¯¼æ•°', 'è¿ç»­æ€§']
                  },
                  {
                      'id': 'M2-002',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬äºŒç« ',
                      'knowledge_point': 'å¤åˆå‡½æ•°æ±‚å¯¼',
                      'content': r'æ±‚å‡½æ•° $y = e^{\sin^2 x}$ çš„å¯¼æ•°',
                      'answer': r'$y' = e^{\sin^2 x} \cdot 2\sin x \cdot \cos x = e^{\sin^2 x} \sin 2x$',
                      'explanation': r'ä½¿ç”¨é“¾å¼æ³•åˆ™ï¼š$y' = e^{\sin^2 x} \cdot 2\sin x \cdot \cos x$',
                      'difficulty': 3,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['å¤åˆå‡½æ•°', 'é“¾å¼æ³•åˆ™']
                  },
                  {
                      'id': 'M2-003',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬äºŒç« ',
                      'knowledge_point': 'éšå‡½æ•°æ±‚å¯¼',
                      'content': r'æ±‚æ–¹ç¨‹ $x^2 + y^2 = R^2$ æ‰€ç¡®å®šçš„éšå‡½æ•°çš„å¯¼æ•° $y\'$',
                      'answer': r'$y\' = -\frac{x}{y}$',
                      'explanation': r'ä¸¤è¾¹å¯¹$x$æ±‚å¯¼ï¼š$2x + 2yy\' = 0$ï¼Œå¾—$y\' = -\frac{x}{y}$',
                      'difficulty': 3,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['éšå‡½æ•°', 'æ±‚å¯¼']
                  },
                  {
                      'id': 'M2-004',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬äºŒç« ',
                      'knowledge_point': 'å‚æ•°æ–¹ç¨‹æ±‚å¯¼',
                      'content': r'è®¾ $x = t^2, y = t^3$ï¼Œæ±‚ $\frac{dy}{dx}$',
                      'answer': r'$\frac{dy}{dx} = \frac{3t}{2}$',
                      'explanation': r'$\frac{dy}{dx} = \frac{dy/dt}{dx/dt} = \frac{3t^2}{2t} = \frac{3t}{2}$',
                      'difficulty': 2,
                      'points': 8,
                      'estimated_time': 8,
                      'tags': ['å‚æ•°æ–¹ç¨‹', 'æ±‚å¯¼']
                  },
                  {
                      'id': 'M2-005',
                      'type': 'åº”ç”¨é¢˜',
                      'chapter': 'ç¬¬äºŒç« ',
                      'knowledge_point': 'å¯¼æ•°åº”ç”¨',
                      'content': r'ä¸€ä¸ªçƒä½“ä½“ç§¯å˜åŒ–ç‡ä¸º $12\pi$ cmÂ³/sï¼Œå½“åŠå¾„ä¸º 2 cm æ—¶ï¼ŒåŠå¾„å˜åŒ–ç‡ä¸ºå¤šå°‘ï¼Ÿ',
                      'answer': r'åŠå¾„å˜åŒ–ç‡ä¸º $0.75$ cm/s',
                      'explanation': r'$V = \frac{4}{3}\pi r^3$ï¼Œ$\frac{dV}{dt} = 4\pi r^2 \frac{dr}{dt}$ï¼Œä»£å…¥å¾—$\frac{dr}{dt} = \frac{12\pi}{16\pi} = 0.75$',
                      'difficulty': 4,
                      'points': 12,
                      'estimated_time': 15,
                      'tags': ['å¯¼æ•°åº”ç”¨', 'å˜åŒ–ç‡']
                  }
              ],
              'ç¬¬ä¸‰ç«  ç§¯åˆ†': [
                  {
                      'id': 'M3-001',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬ä¸‰ç« ',
                      'knowledge_point': 'ä¸å®šç§¯åˆ†',
                      'content': r'è‹¥ $\int f(x) dx = x^2 + C$ï¼Œåˆ™ $f(x) = $',
                      'options': ['$2x$', '$2x + C$', '$x^2$', '$\frac{x^3}{3}$'],
                      'answer': 0,
                      'explanation': r'ç”±ä¸å®šç§¯åˆ†å®šä¹‰ï¼Œ$f(x) = (x^2 + C)\' = 2x$',
                      'difficulty': 1,
                      'points': 5,
                      'estimated_time': 3,
                      'tags': ['ä¸å®šç§¯åˆ†', 'åŸºæœ¬æ¦‚å¿µ']
                  },
                  {
                      'id': 'M3-002',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬ä¸‰ç« ',
                      'knowledge_point': 'æ¢å…ƒç§¯åˆ†æ³•',
                      'content': r'è®¡ç®—ä¸å®šç§¯åˆ†ï¼š$\int x e^{x^2} dx$',
                      'answer': r'$\frac{1}{2} e^{x^2} + C$',
                      'explanation': r'ä»¤$u = x^2$ï¼Œ$du = 2x dx$ï¼ŒåŸå¼$= \frac{1}{2} \int e^u du = \frac{1}{2} e^{x^2} + C$',
                      'difficulty': 2,
                      'points': 8,
                      'estimated_time': 8,
                      'tags': ['æ¢å…ƒæ³•', 'æŒ‡æ•°å‡½æ•°']
                  },
                  {
                      'id': 'M3-003',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬ä¸‰ç« ',
                      'knowledge_point': 'åˆ†éƒ¨ç§¯åˆ†æ³•',
                      'content': r'è®¡ç®—ä¸å®šç§¯åˆ†ï¼š$\int x \cos x dx$',
                      'answer': r'$x \sin x + \cos x + C$',
                      'explanation': r'åˆ†éƒ¨ç§¯åˆ†ï¼š$u=x, dv=\cos x dx$ï¼Œ$du=dx, v=\sin x$ï¼ŒåŸå¼$= x\sin x - \int \sin x dx = x\sin x + \cos x + C$',
                      'difficulty': 3,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['åˆ†éƒ¨ç§¯åˆ†', 'ä¸‰è§’å‡½æ•°']
                  },
                  {
                      'id': 'M3-004',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬ä¸‰ç« ',
                      'knowledge_point': 'å®šç§¯åˆ†',
                      'content': r'è®¡ç®—å®šç§¯åˆ†ï¼š$\int_0^{\pi/2} \sin^2 x dx$',
                      'answer': r'$\frac{\pi}{4}$',
                      'explanation': r'ä½¿ç”¨é™å¹‚å…¬å¼ï¼š$\sin^2 x = \frac{1-\cos 2x}{2}$ï¼Œç§¯åˆ†å¾—$[\frac{x}{2} - \frac{\sin 2x}{4}]_0^{\pi/2} = \frac{\pi}{4}$',
                      'difficulty': 3,
                      'points': 12,
                      'estimated_time': 12,
                      'tags': ['å®šç§¯åˆ†', 'ä¸‰è§’å‡½æ•°']
                  },
                  {
                      'id': 'M3-005',
                      'type': 'åº”ç”¨é¢˜',
                      'chapter': 'ç¬¬ä¸‰ç« ',
                      'knowledge_point': 'å®šç§¯åˆ†åº”ç”¨',
                      'content': r'æ±‚æ›²çº¿ $y = \sqrt{x}$ ä¸ $x$ è½´åœ¨ $[0, 4]$ åŒºé—´å›´æˆçš„å›¾å½¢é¢ç§¯',
                      'answer': r'$\frac{16}{3}$',
                      'explanation': r'é¢ç§¯ $= \int_0^4 \sqrt{x} dx = [\frac{2}{3} x^{3/2}]_0^4 = \frac{2}{3} \cdot 8 = \frac{16}{3}$',
                      'difficulty': 2,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['å®šç§¯åˆ†åº”ç”¨', 'é¢ç§¯']
                  }
              ],
              'ç¬¬å››ç«  å¤šå…ƒå‡½æ•°': [
                  {
                      'id': 'M4-001',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬å››ç« ',
                      'knowledge_point': 'åå¯¼æ•°',
                      'content': r'è®¾ $z = x^2 + y^2$ï¼Œåˆ™ $\frac{\partial z}{\partial x} =$',
                      'options': ['$2x$', '$2y$', '$2x + 2y$', '$x^2$'],
                      'answer': 0,
                      'explanation': r'å¯¹$x$æ±‚åå¯¼ï¼Œ$y$è§†ä¸ºå¸¸æ•°ï¼š$\frac{\partial}{\partial x}(x^2 + y^2) = 2x$',
                      'difficulty': 1,
                      'points': 5,
                      'estimated_time': 3,
                      'tags': ['åå¯¼æ•°', 'å¤šå…ƒå‡½æ•°']
                  },
                  {
                      'id': 'M4-002',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬å››ç« ',
                      'knowledge_point': 'äºŒé˜¶åå¯¼æ•°',
                      'content': r'è®¾ $z = e^{xy}$ï¼Œæ±‚ $\frac{\partial^2 z}{\partial x \partial y}$',
                      'answer': r'$(1 + xy)e^{xy}$',
                      'explanation': r'å…ˆå¯¹$x$æ±‚åå¯¼ï¼š$\frac{\partial z}{\partial x} = ye^{xy}$ï¼Œå†å¯¹$y$æ±‚åå¯¼ï¼š$\frac{\partial^2 z}{\partial x \partial y} = e^{xy} + xy e^{xy} = (1+xy)e^{xy}$',
                      'difficulty': 4,
                      'points': 12,
                      'estimated_time': 15,
                      'tags': ['äºŒé˜¶åå¯¼', 'å¤åˆå‡½æ•°']
                  }
              ],
              'ç¬¬äº”ç«  çº§æ•°': [
                  {
                      'id': 'M5-001',
                      'type': 'å•é€‰é¢˜',
                      'chapter': 'ç¬¬äº”ç« ',
                      'knowledge_point': 'çº§æ•°æ”¶æ•›',
                      'content': r'çº§æ•° $\sum_{n=1}^{\infty} \frac{1}{n^2}$ çš„æ”¶æ•›æ€§ä¸º',
                      'options': ['å‘æ•£', 'æ”¶æ•›', 'æ¡ä»¶æ”¶æ•›', 'æ— æ³•åˆ¤æ–­'],
                      'answer': 1,
                      'explanation': r'p-çº§æ•°ï¼Œ$p=2>1$ï¼Œæ•…æ”¶æ•›',
                      'difficulty': 2,
                      'points': 5,
                      'estimated_time': 5,
                      'tags': ['p-çº§æ•°', 'æ”¶æ•›æ€§']
                  },
                  {
                      'id': 'M5-002',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'ç¬¬äº”ç« ',
                      'knowledge_point': 'å¹‚çº§æ•°',
                      'content': r'æ±‚å¹‚çº§æ•° $\sum_{n=0}^{\infty} \frac{x^n}{n!}$ çš„å’Œå‡½æ•°',
                      'answer': r'$e^x$',
                      'explanation': r'è¿™æ˜¯$e^x$çš„æ³°å‹’å±•å¼€å¼ï¼Œæ•…å’Œå‡½æ•°ä¸º$e^x$',
                      'difficulty': 3,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['å¹‚çº§æ•°', 'å’Œå‡½æ•°']
                  }
              ]
          }
          
          # ä»GitHub Issuesè·å–è‡ªå®šä¹‰é¢˜åº“
          print("ğŸ” ä»é¢˜åº“Issuesè·å–è‡ªå®šä¹‰é¢˜ç›®...")
          custom_questions = []
          try:
              issues = repo.get_issues(state='all', labels=['é¢˜åº“'])
              
              for issue in issues:
                  if not any(label.name == 'é¢˜åº“' for label in issue.labels):
                      continue
                  
                  body = issue.body or ''
                  
                  # å°è¯•è§£æIssueä¸­çš„é¢˜ç›®ä¿¡æ¯
                  question = {
                      'id': f'C-{issue.number}',
                      'type': 'è®¡ç®—é¢˜',
                      'chapter': 'è‡ªå®šä¹‰',
                      'knowledge_point': 'è‡ªå®šä¹‰çŸ¥è¯†ç‚¹',
                      'content': body,
                      'answer': 'è§Issueè¯„è®º',
                      'explanation': '',
                      'difficulty': 3,
                      'points': 10,
                      'estimated_time': 10,
                      'tags': ['è‡ªå®šä¹‰']
                  }
                  
                  # è§£æå…ƒæ•°æ®
                  for line in body.split('\n'):
                      if 'éš¾åº¦' in line or 'Difficulty' in line.lower():
                          try:
                              question['difficulty'] = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†', '').replace('çº§', ''))
                          except:
                              pass
                      if 'ç« èŠ‚' in line or 'Chapter' in line.lower():
                          question['chapter'] = line.split('ï¼š')[-1].split(':')[-1].strip()
                      if 'çŸ¥è¯†ç‚¹' in line or 'Knowledge' in line.lower():
                          question['knowledge_point'] = line.split('ï¼š')[-1].split(':')[-1].strip()
                      if 'é¢˜å‹' in line or 'Type' in line.lower():
                              if 'å•é€‰' in line:
                                  question['type'] = 'å•é€‰é¢˜'
                              elif 'å¤šé€‰' in line:
                                  question['type'] = 'å¤šé€‰é¢˜'
                              elif 'è¯æ˜' in line:
                                  question['type'] = 'è¯æ˜é¢˜'
                              elif 'åº”ç”¨' in line:
                                  question['type'] = 'åº”ç”¨é¢˜'
                  
                  custom_questions.append(question)
              
              if custom_questions:
                  print(f"   æ‰¾åˆ° {len(custom_questions)} é“è‡ªå®šä¹‰é¢˜ç›®")
                  enhanced_question_bank['è‡ªå®šä¹‰'] = custom_questions
              
          except Exception as e:
              print(f"   è·å–è‡ªå®šä¹‰é¢˜åº“å¤±è´¥: {e}")
          
          # è‡ªé€‚åº”æ¨¡å¼ï¼šè¯»å–å­¦ç”Ÿå†å²æˆç»©æ•°æ®
          adaptive_difficulty = target_difficulty
          if adaptive_mode:
              print("ğŸ“Š å¯ç”¨è‡ªé€‚åº”æ¨¡å¼ï¼Œåˆ†æå­¦ç”Ÿå†å²æ•°æ®...")
              try:
                  with open('data/stats_enhanced.json', 'r', encoding='utf-8') as f:
                      stats = json.load(f)
                  
                  # è®¡ç®—å…¨ç­å¹³å‡ç†è§£ç¨‹åº¦
                  if 'students' in stats and len(stats['students']) > 0:
                      total_understanding = sum(s.get('avg_understanding', 3) for s in stats['students'].values())
                      avg_understanding = total_understanding / len(stats['students'])
                      
                      # æ ¹æ®å­¦ç”Ÿæ°´å¹³è°ƒæ•´éš¾åº¦
                      if avg_understanding >= 4:
                          adaptive_difficulty = min(5, target_difficulty + 1)
                          print(f"   å­¦ç”Ÿæ°´å¹³è¾ƒé«˜ï¼Œéš¾åº¦è°ƒæ•´ä¸º: {adaptive_difficulty}")
                      elif avg_understanding <= 2:
                          adaptive_difficulty = max(1, target_difficulty - 1)
                          print(f"   å­¦ç”Ÿæ°´å¹³è¾ƒä½ï¼Œéš¾åº¦è°ƒæ•´ä¸º: {adaptive_difficulty}")
                      else:
                          print(f"   å­¦ç”Ÿæ°´å¹³é€‚ä¸­ï¼Œä¿æŒéš¾åº¦: {adaptive_difficulty}")
                  
              except Exception as e:
                  print(f"   è¯»å–å†å²æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤éš¾åº¦: {target_difficulty}")
          
          # ç­›é€‰é¢˜ç›®
          all_questions = []
          for chapter_name, questions in enhanced_question_bank.items():
              for q in questions:
                  q['source_chapter'] = chapter_name
                  all_questions.append(q)
          
          # æŒ‰è¯¾ç¨‹ç« èŠ‚ç­›é€‰
          if course != 'å…¨éƒ¨ç« èŠ‚' and course in enhanced_question_bank:
              filtered_questions = [q for q in all_questions if q['source_chapter'] == course]
          else:
              filtered_questions = all_questions
          
          # æŒ‰éš¾åº¦ç­›é€‰ï¼ˆè‡ªé€‚åº”ä½¿ç”¨è°ƒæ•´åçš„éš¾åº¦ï¼‰
          difficulty_range = max(0, adaptive_difficulty - 1)
          difficulty_filtered = [q for q in filtered_questions 
                                 if abs(q['difficulty'] - adaptive_difficulty) <= difficulty_range]
          
          if not difficulty_filtered:
              difficulty_filtered = filtered_questions
              print(f"âš ï¸  æœªæ‰¾åˆ°éš¾åº¦{adaptive_difficulty}çš„é¢˜ç›®ï¼Œä½¿ç”¨å…¨éƒ¨å¯ç”¨é¢˜ç›®")
          
          # æ™ºèƒ½é€‰é¢˜ï¼šå¹³è¡¡é¢˜å‹å’ŒçŸ¥è¯†ç‚¹
          type_distribution = {
              'å•é€‰é¢˜': int(question_count * 0.4),
              'å¤šé€‰é¢˜': int(question_count * 0.2),
              'è®¡ç®—é¢˜': int(question_count * 0.3),
              'è¯æ˜é¢˜': int(question_count * 0.05),
              'åº”ç”¨é¢˜': int(question_count * 0.05)
          }
          
          # ä¿®æ­£åˆ†é…
          remaining = question_count - sum(type_distribution.values())
          type_distribution['è®¡ç®—é¢˜'] += remaining
          
          selected_questions = []
          
          for question_type, count in type_distribution.items():
              if count <= 0:
                  continue
              
              type_questions = [q for q in difficulty_filtered if q['type'] == question_type]
              
              if len(type_questions) >= count:
                  # ä¼˜å…ˆé€‰æ‹©ä¸åŒçŸ¥è¯†ç‚¹
                  knowledge_points = {}
                  for q in type_questions:
                      kp = q.get('knowledge_point', 'default')
                      if kp not in knowledge_points:
                          knowledge_points[kp] = []
                      knowledge_points[kp].append(q)
                  
                  # ä»ä¸åŒçŸ¥è¯†ç‚¹ä¸­éšæœºé€‰æ‹©
                  selected_from_type = []
                  remaining_to_select = count
                  
                  knowledge_keys = list(knowledge_points.keys())
                  random.shuffle(knowledge_keys)
                  
                  for kp in knowledge_keys:
                      if remaining_to_select <= 0:
                          break
                      
                      questions_from_kp = random.sample(
                          knowledge_points[kp],
                          min(len(knowledge_points[kp]), 1 + remaining_to_select // len(knowledge_keys))
                      )
                      selected_from_type.extend(questions_from_kp)
                      remaining_to_select -= len(questions_from_kp)
                  
                  # å¦‚æœè¿˜ä¸å¤Ÿï¼Œä»ä»»æ„é¢˜ç›®ä¸­è¡¥å……
                  if len(selected_from_type) < count:
                      remaining = count - len(selected_from_type)
                      available = [q for q in type_questions if q not in selected_from_type]
                      selected_from_type.extend(random.sample(available, min(len(available), remaining)))
                  
                  selected_questions.extend(selected_from_type[:count])
              else:
                  # é¢˜ç›®ä¸å¤Ÿï¼Œå…¨éƒ¨ä½¿ç”¨
                  selected_questions.extend(type_questions)
          
          # æŒ‰éš¾åº¦æ’åºï¼ˆç®€å•åˆ°å¤æ‚ï¼‰
          selected_questions.sort(key=lambda x: x['difficulty'])
          
          # è®¡ç®—æ€»åˆ†å’Œé¢„è®¡æ—¶é—´
          total_points = sum(q['points'] for q in selected_questions)
          total_time = sum(q.get('estimated_time', 10) for q in selected_questions)
          exam_duration = max(30, (total_time // 5) * 5)  # å‘ä¸Šå–æ•´åˆ°5çš„å€æ•°
          
          # ç”Ÿæˆè¯•å·å…ƒæ•°æ®
          exam_metadata = {
              'exam_id': datetime.now().strftime('%Y%m%d%H%M%S'),
              'exam_type': exam_type,
              'course': course,
              'created_at': datetime.now().isoformat(),
              'difficulty_level': adaptive_difficulty,
              'adaptive_mode': adaptive_mode,
              'duration': exam_duration,
              'total_points': total_points,
              'question_count': len(selected_questions),
              'passing_score': int(total_points * 0.6),  # åŠæ ¼åˆ†
              'estimated_time': total_time,
              'statistics': {
                  'type_distribution': type_distribution,
                  'difficulty_distribution': {},
                  'knowledge_points_coverage': []
              }
          }
          
          # ç»Ÿè®¡éš¾åº¦åˆ†å¸ƒ
          for q in selected_questions:
              diff = str(q['difficulty'])
              exam_metadata['statistics']['difficulty_distribution'][diff] = \
                  exam_metadata['statistics']['difficulty_distribution'].get(diff, 0) + 1
              
              kp = q.get('knowledge_point', 'æœªçŸ¥')
              if kp not in exam_metadata['statistics']['knowledge_points_coverage']:
                  exam_metadata['statistics']['knowledge_points_coverage'].append(kp)
          
          # ç”Ÿæˆå®Œæ•´è¯•å·
          exam = {
              **exam_metadata,
              'questions': selected_questions,
              'instructions': [
                  f'è€ƒè¯•æ—¶é—´ï¼š{exam_duration}åˆ†é’Ÿ',
                  f'æ€»åˆ†ï¼š{total_points}åˆ†',
                  f'åŠæ ¼åˆ†ï¼š{int(total_points * 0.6)}åˆ†',
                  'è¯·åœ¨è§„å®šæ—¶é—´å†…å®Œæˆæ‰€æœ‰é¢˜ç›®',
                  'è®¡ç®—é¢˜éœ€å†™å‡ºè¯¦ç»†è¿‡ç¨‹',
                  'è¯æ˜é¢˜éœ€å†™å‡ºå®Œæ•´è¯æ˜è¿‡ç¨‹'
              ],
              'scoring_criteria': {
                  'å•é€‰é¢˜': 'ç­”æ¡ˆæ­£ç¡®å¾—æ»¡åˆ†ï¼Œé”™è¯¯ä¸å¾—åˆ†',
                  'å¤šé€‰é¢˜': 'å…¨å¯¹å¾—æ»¡åˆ†ï¼Œéƒ¨åˆ†æ­£ç¡®å¾—ä¸€åŠåˆ†ï¼Œé”™è¯¯ä¸å¾—åˆ†',
                  'è®¡ç®—é¢˜': 'ç»“æœæ­£ç¡®å¾—60%åˆ†æ•°ï¼Œè¿‡ç¨‹å®Œæ•´å¾—40%åˆ†æ•°',
                  'è¯æ˜é¢˜': 'è¯æ˜è¿‡ç¨‹å®Œæ•´å¾—æ»¡åˆ†ï¼Œé€»è¾‘ä¸¥å¯†å¾—é¢å¤–åŠ åˆ†',
                  'åº”ç”¨é¢˜': 'è§£é¢˜æ€è·¯æ¸…æ™°å¾—40%ï¼Œè®¡ç®—æ­£ç¡®å¾—60%'
              }
          }
          
          # ä¿å­˜è¯•å·
          exam_filename = f"exam_{datetime.now().strftime('%Y%m%d')}.json"
          with open(f'data/exams/{exam_filename}', 'w', encoding='utf-8') as f:
              json.dump(exam, f, ensure_ascii=False, indent=2)
          
          # æ›´æ–°å†å²è®°å½•
          history_file = 'data/exam_history/index.json'
          try:
              with open(history_file, 'r', encoding='utf-8') as f:
                  history = json.load(f)
          except:
              history = {'exams': []}
          
          history['exams'].append({
              'exam_id': exam['exam_id'],
              'exam_type': exam_type,
              'course': course,
              'created_at': exam['created_at'],
              'question_count': len(selected_questions),
              'total_points': total_points,
              'difficulty': adaptive_difficulty,
              'file': exam_filename
          })
          
          history['exams'] = sorted(history['exams'], 
                                     key=lambda x: x['created_at'], 
                                     reverse=True)
          
          with open(history_file, 'w', encoding='utf-8') as f:
              json.dump(history, f, ensure_ascii=False, indent=2)
          
          # ç”Ÿæˆå­¦ç”Ÿç­”é¢˜å¡æ¨¡æ¿
          answer_sheet = {
              'exam_id': exam['exam_id'],
              'student_name': '',
              'student_id': '',
              'submit_time': '',
              'answers': {},
              'score': 0,
              'time_spent': 0
          }
          
          for q in selected_questions:
              q_id = q['id']
              if q['type'] in ['å•é€‰é¢˜', 'å¤šé€‰é¢˜']:
                  answer_sheet['answers'][q_id] = {'selected': None, 'correct': q['answer']}
              else:
                  answer_sheet['answers'][q_id] = {'content': '', 'correct': q['answer']}
          
          answer_sheet_filename = f"answer_sheet_template_{datetime.now().strftime('%Y%m%d')}.json"
          with open(f'data/exams/{answer_sheet_filename}', 'w', encoding='utf-8') as f:
              json.dump(answer_sheet, f, ensure_ascii=False, indent=2)
          
          print("âœ… å¢å¼ºè¯•å·ç”Ÿæˆå®Œæˆï¼")
          print(f"   è¯•å·ID: {exam['exam_id']}")
          print(f"   é¢˜ç›®æ•°é‡: {len(selected_questions)}")
          print(f"   æ€»åˆ†: {total_points}")
          print(f"   è€ƒè¯•æ—¶é•¿: {exam_duration}åˆ†é’Ÿ")
          print(f"   éš¾åº¦: {adaptive_difficulty}ï¼ˆè‡ªé€‚åº”: {adaptive_mode}ï¼‰")
          print(f"   é¢„è®¡å®Œæˆæ—¶é—´: {total_time}åˆ†é’Ÿ")
          print("\nğŸ“‹ é¢˜å‹åˆ†å¸ƒ:")
          for qtype, count in type_distribution.items():
              if count > 0:
                  print(f"   {qtype}: {count}é¢˜")
          print(f"\nğŸ“Š çŸ¥è¯†ç‚¹è¦†ç›–: {len(exam['statistics']['knowledge_points_coverage'])}ä¸ª")
          print(f"\nğŸ“„ æ–‡ä»¶: {exam_filename}, {answer_sheet_filename}")
          EOF
      
      - name: æäº¤è¯•å·æ–‡ä»¶
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/exams/ data/exam_history/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“ ç”Ÿæˆå¢å¼ºè¯•å· [è‡ªåŠ¨è¿è¡Œ]"
          git push
