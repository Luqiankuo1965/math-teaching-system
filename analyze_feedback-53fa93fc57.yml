name: åˆ†æå­¦ç”Ÿåé¦ˆæ•°æ®

on:
  # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“æœ‰æ–°çš„åé¦ˆIssueæäº¤æ—¶è§¦å‘
  issues:
    types: [opened, edited, closed]

permissions:
  contents: write
  issues: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pygithub requests
      
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: mkdir -p data
      
      - name: è¿è¡Œåˆ†æè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from github import Github
          
          # åˆå§‹åŒ–GitHubå®¢æˆ·ç«¯
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          g = Github(token)
          repo = g.get_repo(repo_name)
          
          # è·å–æ‰€æœ‰åé¦ˆIssues
          print("ğŸ” è·å–åé¦ˆIssues...")
          issues = repo.get_issues(state='all', labels=['åé¦ˆ'])
          
          stats = {
              'last_updated': datetime.now().isoformat(),
              'total_issues': 0,
              'courses': {},
              'students': {},
              'daily_stats': {},
              'weekly_stats': {},
              'issues_detail': []
          }
          
          # åˆå§‹åŒ–æ—¥æœŸç»Ÿè®¡
          today = datetime.now()
          for i in range(30):
              date = (today - timedelta(days=i)).strftime('%Y-%m-%d')
              stats['daily_stats'][date] = {'count': 0}
          
          # åˆå§‹åŒ–å‘¨ç»Ÿè®¡
          for i in range(12):
              year, week, _ = (today - timedelta(weeks=i)).isocalendar()
              week_key = f"{year}-W{week:02d}"
              stats['weekly_stats'][week_key] = {'count': 0, 'avg_difficulty': 0}
          
          student_feedbacks = {}
          
          # éå†Issues
          for issue in issues:
              # è·³è¿‡éåé¦ˆIssue
              if not any(label.name == 'åé¦ˆ' for label in issue.labels):
                  continue
              
              stats['total_issues'] += 1
              
              # è§£æIssueå†…å®¹
              body = issue.body or ''
              created_at = issue.created_at
              date_key = created_at.strftime('%Y-%m-%d')
              year, week, _ = created_at.isocalendar()
              week_key = f"{year}-W{week:02d}"
              
              # æå–ä¿¡æ¯
              course = 'æœªçŸ¥è¯¾ç¨‹'
              student_name = 'åŒ¿åå­¦ç”Ÿ'
              difficulty = 3
              
              for line in body.split('\n'):
                  if 'è¯¾ç¨‹åç§°' in line or 'è¯¾ç¨‹' in line:
                      course = line.split('ï¼š')[-1].split(':')[-1].strip()
                  if 'å§“å' in line or 'å­¦ç”Ÿ' in line:
                      student_name = line.split('ï¼š')[-1].split(':')[-1].strip()
                  if 'éš¾åº¦' in line:
                      try:
                          difficulty = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†', ''))
                      except:
                          difficulty = 3
              
              # ç»Ÿè®¡è¯¾ç¨‹
              if course not in stats['courses']:
                  stats['courses'][course] = {
                      'total_feedback': 0,
                      'student_count': 0,
                      'difficulty': {'1': 0, '2': 0, '3': 0, '4': 0, '5': 0}
                  }
              
              stats['courses'][course]['total_feedback'] += 1
              
              # è®°å½•å­¦ç”Ÿå‚ä¸æƒ…å†µ
              if course not in stats['courses'][course].get('students', set()):
                  stats['courses'][course]['student_count'] += 1
                  stats['courses'][course]['students'] = set()
              stats['courses'][course]['students'].add(student_name)
              
              # ç»Ÿè®¡éš¾åº¦
              difficulty_key = str(max(1, min(5, difficulty)))
              stats['courses'][course]['difficulty'][difficulty_key] += 1
              
              # ç»Ÿè®¡å­¦ç”Ÿ
              if student_name not in stats['students']:
                  stats['students'][student_name] = {
                      'name': student_name,
                      'total_feedback': 0,
                      'avg_difficulty': 0
                  }
              
              stats['students'][student_name]['total_feedback'] += 1
              
              # è®°å½•åé¦ˆè¯¦æƒ…ï¼ˆç”¨äºè®¡ç®—å¹³å‡éš¾åº¦ï¼‰
              if student_name not in student_feedbacks:
                  student_feedbacks[student_name] = []
              student_feedbacks[student_name].append(difficulty)
              
              # æ¯æ—¥ç»Ÿè®¡
              if date_key in stats['daily_stats']:
                  stats['daily_stats'][date_key]['count'] += 1
              
              # æ¯å‘¨ç»Ÿè®¡
              if week_key in stats['weekly_stats']:
                  stats['weekly_stats'][week_key]['count'] += 1
              
              # ä¿å­˜è¯¦ç»†è®°å½•ï¼ˆç”¨äºåç»­åˆ†æï¼‰
              stats['issues_detail'].append({
                  'id': issue.number,
                  'title': issue.title,
                  'course': course,
                  'student': student_name,
                  'difficulty': difficulty,
                  'created_at': created_at.isoformat(),
                  'state': issue.state
              })
          
          # è®¡ç®—å­¦ç”Ÿçš„å¹³å‡éš¾åº¦
          for student_name in stats['students']:
              feedbacks = student_feedbacks[student_name]
              if feedbacks:
                  stats['students'][student_name]['avg_difficulty'] = round(
                      sum(feedbacks) / len(feedbacks), 2
                  )
          
          # è®¡ç®—å‘¨ç»Ÿè®¡çš„å¹³å‡éš¾åº¦
          weekly_difficulties = {}
          for week_key in stats['weekly_stats']:
              weekly_difficulties[week_key] = []
          
          for issue in stats['issues_detail']:
              created_at = datetime.fromisoformat(issue['created_at'])
              year, week, _ = created_at.isocalendar()
              week_key = f"{year}-W{week:02d}"
              if week_key in weekly_difficulties:
                  weekly_difficulties[week_key].append(issue['difficulty'])
          
          for week_key in stats['weekly_stats']:
              difficulties = weekly_difficulties.get(week_key, [])
              if difficulties:
                  stats['weekly_stats'][week_key]['avg_difficulty'] = round(
                      sum(difficulties) / len(difficulties), 2
                  )
              else:
                  stats['weekly_stats'][week_key]['avg_difficulty'] = 0
          
          # æ¸…ç†coursesä¸­çš„ä¸´æ—¶set
          for course in stats['courses']:
              if 'students' in stats['courses'][course]:
                  del stats['courses'][course]['students']
          
          # ä¿å­˜ç»Ÿè®¡æ•°æ®
          with open('data/stats.json', 'w', encoding='utf-8') as f:
              json.dump(stats, f, ensure_ascii=False, indent=2)
          
          print("âœ… æ•°æ®åˆ†æå®Œæˆï¼")
          print(f"ğŸ“Š æ€»åé¦ˆæ•°: {stats['total_issues']}")
          print(f"ğŸ“š è¯¾ç¨‹æ•°: {len(stats['courses'])}")
          print(f"ğŸ‘¥ å­¦ç”Ÿæ•°: {len(stats['students'])}")
          EOF
      
      - name: æäº¤ç»Ÿè®¡æ–‡ä»¶
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/stats.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š æ›´æ–°æ•™å­¦æ•°æ®ç»Ÿè®¡ [è‡ªåŠ¨è¿è¡Œ]"
          git push
