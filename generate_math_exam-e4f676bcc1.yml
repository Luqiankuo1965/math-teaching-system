name: ç”Ÿæˆæ•°å­¦è¯•å·

on:
  # æ¯å‘¨æ—¥ä¸Šåˆ8ç‚¹è‡ªåŠ¨ç”Ÿæˆï¼ˆåŒ—äº¬æ—¶é—´ä¸‹åˆ4ç‚¹ï¼‰
  schedule:
    - cron: '0 8 * * 0'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      exam_type:
        description: 'è¯•å·ç±»å‹'
        required: true
        type: choice
        options:
          - å•å…ƒæµ‹è¯•
          - æœŸä¸­è€ƒè¯•
          - æœŸæœ«è€ƒè¯•
          - éšæœºç»ƒä¹ 
        default: 'å•å…ƒæµ‹è¯•'
      question_count:
        description: 'é¢˜ç›®æ•°é‡'
        required: true
        type: number
        default: 10
      difficulty:
        description: 'éš¾åº¦ç­‰çº§ (1-5)'
        required: true
        type: number
        default: 3

permissions:
  contents: write
  issues: read

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pygithub requests numpy
      
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: mkdir -p data
      
      - name: è¿è¡Œè¯•å·ç”Ÿæˆè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          EXAM_TYPE: ${{ github.event.inputs.exam_type || 'å•å…ƒæµ‹è¯•' }}
          QUESTION_COUNT: ${{ github.event.inputs.question_count || 10 }}
          DIFFICULTY: ${{ github.event.inputs.difficulty || 3 }}
        run: |
          python << 'EOF'
          import json
          import os
          import random
          from datetime import datetime
          from github import Github
          
          # åˆå§‹åŒ–GitHubå®¢æˆ·ç«¯
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          g = Github(token)
          repo = g.get_repo(repo_name)
          
          # è·å–è¾“å…¥å‚æ•°
          exam_type = os.environ.get('EXAM_TYPE', 'å•å…ƒæµ‹è¯•')
          question_count = int(os.environ.get('QUESTION_COUNT', 10))
          target_difficulty = int(os.environ.get('DIFFICULTY', 3))
          
          print(f"ğŸ“ å¼€å§‹ç”Ÿæˆ{exam_type}è¯•å·...")
          print(f"   é¢˜ç›®æ•°é‡: {question_count}")
          print(f"   ç›®æ ‡éš¾åº¦: {target_difficulty}")
          
          # æ•°å­¦é¢˜åº“ï¼ˆåŒ…å«LaTeXå…¬å¼ï¼‰
          question_bank = {
              'å¾®ç§¯åˆ†': [
                  {
                      'id': 1,
                      'type': 'å•é€‰é¢˜',
                      'content': r'è®¡ç®—æé™ï¼š$$\lim_{x\to 0} \frac{\sin x}{x}$$',
                      'options': ['0', '1', 'âˆ', 'ä¸å­˜åœ¨'],
                      'answer': 1,  # ç´¢å¼•ï¼Œä»0å¼€å§‹
                      'difficulty': 1,
                      'points': 5
                  },
                  {
                      'id': 2,
                      'type': 'å•é€‰é¢˜',
                      'content': r'æ±‚å¯¼æ•°ï¼š$\frac{d}{dx}(e^x + x^2)$',
                      'options': [r'$e^x + 2x$', r'$e^x + x$', r'$e^{2x} + 2x$', r'$e^x \cdot 2x$'],
                      'answer': 0,
                      'difficulty': 2,
                      'points': 5
                  },
                  {
                      'id': 3,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'è®¡ç®—ä¸å®šç§¯åˆ†ï¼š$\int x^2 e^x dx$',
                      'answer': r'$x^2 e^x - 2\int x e^x dx$ æˆ– $e^x(x^2 - 2x + 2) + C$',
                      'difficulty': 3,
                      'points': 10
                  },
                  {
                      'id': 4,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'æ±‚å®šç§¯åˆ†ï¼š$\int_{0}^{\pi} \sin x dx$',
                      'answer': '2',
                      'difficulty': 1,
                      'points': 8
                  },
                  {
                      'id': 5,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'æ±‚å‡½æ•° $f(x) = x^3 - 3x^2 + 2$ çš„æå€¼',
                      'answer': r'æå¤§å€¼ $f(0)=2$ï¼Œæå°å€¼ $f(2)=-2$',
                      'difficulty': 4,
                      'points': 12
                  },
                  {
                      'id': 6,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'è®¡ç®—æé™ï¼š$$\lim_{x\to \infty} \frac{2x^2 + x}{3x^2 - 5}$$',
                      'answer': r'$\frac{2}{3}$',
                      'difficulty': 2,
                      'points': 8
                  }
              ],
              'çº¿æ€§ä»£æ•°': [
                  {
                      'id': 7,
                      'type': 'å•é€‰é¢˜',
                      'content': r'è®¾ $A = \begin{pmatrix} 1 & 2 \\ 3 & 4 \end{pmatrix}$ï¼Œåˆ™ $|A|$ ç­‰äº',
                      'options': ['-2', '2', '-10', '10'],
                      'answer': 0,
                      'difficulty': 1,
                      'points': 5
                  },
                  {
                      'id': 8,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'æ±‚çŸ©é˜µ $A = \begin{pmatrix} 1 & 2 \\ 3 & 4 \end{pmatrix}$ çš„é€†çŸ©é˜µ',
                      'answer': r'$\begin{pmatrix} -2 & 1 \\ 1.5 & -0.5 \end{pmatrix}$',
                      'difficulty': 3,
                      'points': 10
                  },
                  {
                      'id': 9,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'æ±‚è¡Œåˆ—å¼ $D = \begin{vmatrix} 1 & 2 & 3 \\ 4 & 5 & 6 \\ 7 & 8 & 9 \end{vmatrix}$ çš„å€¼',
                      'answer': '0',
                      'difficulty': 2,
                      'points': 8
                  }
              ],
              'æ¦‚ç‡ç»Ÿè®¡': [
                  {
                      'id': 10,
                      'type': 'å•é€‰é¢˜',
                      'content': r'è®¾ $X \sim N(0,1)$ï¼Œåˆ™ $P(X \leq 1.96)$ çº¦ç­‰äº',
                      'options': ['0.90', '0.95', '0.975', '0.99'],
                      'answer': 2,
                      'difficulty': 2,
                      'points': 5
                  },
                  {
                      'id': 11,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'è®¾ $X \sim B(n,p)$ï¼Œæ±‚ $E(X)$ å’Œ $D(X)$',
                      'answer': r'$E(X) = np$, $D(X) = np(1-p)$',
                      'difficulty': 2,
                      'points': 10
                  }
              ],
              'å¾®åˆ†æ–¹ç¨‹': [
                  {
                      'id': 12,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'æ±‚å¾®åˆ†æ–¹ç¨‹ $\frac{dy}{dx} = \frac{y}{x}$ çš„é€šè§£',
                      'answer': r'$y = Cx$ï¼Œå…¶ä¸­ $C$ ä¸ºå¸¸æ•°',
                      'difficulty': 1,
                      'points': 8
                  },
                  {
                      'id': 13,
                      'type': 'è®¡ç®—é¢˜',
                      'content': r'è§£å¾®åˆ†æ–¹ç¨‹ $y'' + 4y = 0$',
                      'answer': r'$y = C_1 \cos 2x + C_2 \sin 2x$',
                      'difficulty': 3,
                      'points': 12
                  }
              ]
          }
          
          # ä»GitHub Issuesè·å–é¢˜åº“
          print("ğŸ” ä»é¢˜åº“Issuesè·å–é¢˜ç›®...")
          try:
              issues = repo.get_issues(state='all', labels=['é¢˜åº“'])
              custom_questions = []
              
              for issue in issues:
                  if not any(label.name == 'é¢˜åº“' for label in issue.labels):
                      continue
                  
                  body = issue.body or ''
                  question = {
                      'id': issue.number,
                      'type': 'è®¡ç®—é¢˜',
                      'content': body,
                      'answer': 'è§Issueè¯„è®º',
                      'difficulty': 3,
                      'points': 10
                  }
                  
                  # å°è¯•è§£æéš¾åº¦
                  for line in body.split('\n'):
                      if 'éš¾åº¦' in line:
                          try:
                              question['difficulty'] = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†', ''))
                          except:
                              pass
                  
                  custom_questions.append(question)
              
              if custom_questions:
                  print(f"   æ‰¾åˆ° {len(custom_questions)} é“è‡ªå®šä¹‰é¢˜ç›®")
                  question_bank['è‡ªå®šä¹‰'] = custom_questions
              
          except Exception as e:
              print(f"   è·å–è‡ªå®šä¹‰é¢˜åº“å¤±è´¥: {e}")
          
          # é€‰æ‹©é¢˜ç›®
          all_questions = []
          for chapter, questions in question_bank.items():
              for q in questions:
                  q['chapter'] = chapter
                  all_questions.append(q)
          
          # æŒ‰éš¾åº¦ç­›é€‰
          difficulty_range = max(1, target_difficulty - 1)
          filtered_questions = [q for q in all_questions if 
                               abs(q['difficulty'] - target_difficulty) <= difficulty_range]
          
          if not filtered_questions:
              filtered_questions = all_questions
          
          # éšæœºé€‰æ‹©é¢˜ç›®
          selected_questions = random.sample(filtered_questions, 
                                             min(question_count, len(filtered_questions)))
          
          # è®¡ç®—æ€»åˆ†
          total_points = sum(q['points'] for q in selected_questions)
          
          # ç”Ÿæˆè¯•å·JSON
          exam = {
              'exam_id': datetime.now().strftime('%Y%m%d%H%M%S'),
              'exam_type': exam_type,
              'created_at': datetime.now().isoformat(),
              'duration': 120,  # è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
              'total_points': total_points,
              'question_count': len(selected_questions),
              'difficulty_level': target_difficulty,
              'questions': selected_questions
          }
          
          # ä¿å­˜è¯•å·
          with open('data/math_exam.json', 'w', encoding='utf-8') as f:
              json.dump(exam, f, ensure_ascii=False, indent=2)
          
          # ç”Ÿæˆå†å²è®°å½•
          history_file = 'data/exam_history.json'
          try:
              with open(history_file, 'r', encoding='utf-8') as f:
                  history = json.load(f)
          except:
              history = []
          
          history.append({
              'exam_id': exam['exam_id'],
              'exam_type': exam_type,
              'created_at': exam['created_at'],
              'question_count': len(selected_questions),
              'total_points': total_points
          })
          
          with open(history_file, 'w', encoding='utf-8') as f:
              json.dump(history, f, ensure_ascii=False, indent=2)
          
          print("âœ… è¯•å·ç”Ÿæˆå®Œæˆï¼")
          print(f"   é¢˜ç›®æ•°é‡: {len(selected_questions)}")
          print(f"   æ€»åˆ†: {total_points}")
          print(f"   è€ƒè¯•æ—¶é•¿: {exam['duration']}åˆ†é’Ÿ")
          print("\nğŸ“‹ è¯•å·æ¦‚è§ˆï¼š")
          for i, q in enumerate(selected_questions[:5], 1):
              print(f"   {i}. [{q['chapter']}] {q['type']} - {q['points']}åˆ†")
          if len(selected_questions) > 5:
              print(f"   ... å…±{len(selected_questions)}é“é¢˜")
          EOF
      
      - name: æäº¤è¯•å·æ–‡ä»¶
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/math_exam.json data/exam_history.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“ ç”Ÿæˆæ–°è¯•å· [è‡ªåŠ¨è¿è¡Œ]"
          git push
