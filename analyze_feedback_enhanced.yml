name: å­¦ç”Ÿåé¦ˆæ·±åº¦åˆ†æç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©0ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æç±»å‹'
        required: true
        type: choice
        options:
          - å®Œæ•´åˆ†æ
          - ä»…ç”ŸæˆæŠ¥å‘Š
          - ä»…å‘é€é€šçŸ¥
          - å­¦ç”Ÿå­¦ä¹ è½¨è¿¹
        default: 'å®Œæ•´åˆ†æ'

permissions:
  contents: write
  issues: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pygithub requests pandas matplotlib seaborn numpy
          
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: mkdir -p data/reports data/charts data/alerts
      
      - name: è¿è¡Œå¢å¼ºåˆ†æè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ANALYSIS_TYPE: ${{ github.event.inputs.analysis_type || 'å®Œæ•´åˆ†æ' }}
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from github import Github
          import math
          
          # åˆå§‹åŒ–
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          g = Github(token)
          repo = g.get_repo(repo_name)
          analysis_type = os.environ.get('ANALYSIS_TYPE', 'å®Œæ•´åˆ†æ')
          
          print(f"ğŸ” å¼€å§‹{analysis_type}...")
          
          # è·å–æ‰€æœ‰åé¦ˆIssues
          issues = repo.get_issues(state='all', labels=['åé¦ˆ'])
          
          # æ•°æ®ç»“æ„
          stats = {
              'last_updated': datetime.now().isoformat(),
              'analysis_type': analysis_type,
              'total_issues': 0,
              'courses': {},
              'students': {},
              'daily_stats': {},
              'weekly_stats': {},
              'monthly_stats': {},
              'issues_detail': [],
              # æ–°å¢ï¼šé«˜çº§åˆ†æ
              'learning_trajectory': {},  # å­¦ä¹ è½¨è¿¹
              'difficulty_trend': {},     # éš¾åº¦è¶‹åŠ¿
              'engagement_score': {},     # å‚ä¸åº¦è¯„åˆ†
              'at_risk_students': [],     # é«˜é£é™©å­¦ç”Ÿ
              'course_effectiveness': {}, # è¯¾ç¨‹æœ‰æ•ˆæ€§
              'feedback_sentiment': {},   # åé¦ˆæƒ…æ„Ÿåˆ†æ
              'time_patterns': {},        # æ—¶é—´æ¨¡å¼
              'correlation_analysis': {}  # å…³è”æ€§åˆ†æ
          }
          
          # åˆå§‹åŒ–æ—¥æœŸç»Ÿè®¡
          today = datetime.now()
          for i in range(90):
              date = (today - timedelta(days=i)).strftime('%Y-%m-%d')
              stats['daily_stats'][date] = {
                  'count': 0,
                  'avg_difficulty': 0,
                  'difficulty_distribution': {'1': 0, '2': 0, '3': 0, '4': 0, '5': 0}
              }
          
          for i in range(24):
              year, week, _ = (today - timedelta(weeks=i)).isocalendar()
              week_key = f"{year}-W{week:02d}"
              stats['weekly_stats'][week_key] = {
                  'count': 0,
                  'avg_difficulty': 0,
                  'unique_students': set()
              }
          
          for i in range(12):
              month = (today.replace(day=1) - timedelta(days=i*30)).strftime('%Y-%m')
              stats['monthly_stats'][month] = {
                  'count': 0,
                  'avg_difficulty': 0,
                  'unique_students': set()
              }
          
          # å­¦ä¹ è½¨è¿¹æ•°æ®
          student_learning_data = {}
          course_feedback_data = {}
          
          # éå†Issues
          for issue in issues:
              if not any(label.name == 'åé¦ˆ' for label in issue.labels):
                  continue
              
              stats['total_issues'] += 1
              
              body = issue.body or ''
              created_at = issue.created_at
              date_key = created_at.strftime('%Y-%m-%d')
              year, week, _ = created_at.isocalendar()
              week_key = f"{year}-W{02d}" if week < 10 else f"{year}-W{week}"
              month_key = created_at.strftime('%Y-%m')
              
              # æå–ä¿¡æ¯
              course = 'æœªçŸ¥è¯¾ç¨‹'
              student_name = 'åŒ¿åå­¦ç”Ÿ'
              difficulty = 3
              learning_progress = 50  # å­¦ä¹ è¿›åº¦ç™¾åˆ†æ¯”
              understanding_level = 3  # ç†è§£ç¨‹åº¦ 1-5
              time_spent = 30  # å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
              sentiment = 'ä¸­æ€§'  # æƒ…æ„Ÿå€¾å‘
              
              for line in body.split('\n'):
                  line_lower = line.lower()
                  if 'è¯¾ç¨‹' in line or 'course' in line_lower:
                      course = line.split('ï¼š')[-1].split(':')[-1].strip()
                  elif 'å§“å' in line or 'name' in line_lower:
                      student_name = line.split('ï¼š')[-1].split(':')[-1].strip()
                  elif 'éš¾åº¦' in line or 'difficulty' in line_lower:
                      try:
                          difficulty = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†', '').replace('çº§', ''))
                      except:
                          difficulty = 3
                  elif 'è¿›åº¦' in line or 'progress' in line_lower:
                      try:
                          learning_progress = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('%', ''))
                      except:
                          pass
                  elif 'ç†è§£' in line or 'understanding' in line_lower:
                      try:
                          understanding_level = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†', '').replace('çº§', ''))
                      except:
                          understanding_level = 3
                  elif 'æ—¶é•¿' in line or 'time' in line_lower:
                      try:
                          time_spent = int(line.split('ï¼š')[-1].split(':')[-1].strip().replace('åˆ†é’Ÿ', '').replace('min', ''))
                      except:
                          time_spent = 30
                  elif 'æƒ…æ„Ÿ' in line or 'sentiment' in line_lower or 'æ„Ÿå—' in line:
                      sentiment = line.split('ï¼š')[-1].split(':')[-1].strip()
              
              # ç»Ÿè®¡è¯¾ç¨‹
              if course not in stats['courses']:
                  stats['courses'][course] = {
                      'total_feedback': 0,
                      'student_count': 0,
                      'difficulty': {'1': 0, '2': 0, '3': 0, '4': 0, '5': 0},
                      'avg_progress': 0,
                      'avg_understanding': 0,
                      'avg_time_spent': 0,
                      'effectiveness_score': 0,  # è¯¾ç¨‹æœ‰æ•ˆæ€§è¯„åˆ†
                      'sentiment_distribution': {'ç§¯æ': 0, 'ä¸­æ€§': 0, 'æ¶ˆæ': 0}
                  }
              
              stats['courses'][course]['total_feedback'] += 1
              
              # ç´¯åŠ å­¦ä¹ æ•°æ®
              stats['courses'][course]['avg_progress'] += learning_progress
              stats['courses'][course]['avg_understanding'] += understanding_level
              stats['courses'][course]['avg_time_spent'] += time_spent
              
              # ç»Ÿè®¡æƒ…æ„Ÿ
              if sentiment in stats['courses'][course]['sentiment_distribution']:
                  stats['courses'][course]['sentiment_distribution'][sentiment] += 1
              else:
                  stats['courses'][course]['sentiment_distribution']['ä¸­æ€§'] += 1
              
              # è®°å½•å­¦ç”Ÿ
              if course not in stats['courses'][course].get('students', set()):
                  stats['courses'][course]['student_count'] += 1
                  stats['courses'][course]['students'] = set()
              stats['courses'][course]['students'].add(student_name)
              
              # ç»Ÿè®¡éš¾åº¦
              difficulty_key = str(max(1, min(5, difficulty)))
              stats['courses'][course]['difficulty'][difficulty_key] += 1
              
              # å­¦ä¹ è½¨è¿¹æ•°æ®
              if student_name not in student_learning_data:
                  student_learning_data[student_name] = []
              
              student_learning_data[student_name].append({
                  'date': date_key,
                  'course': course,
                  'difficulty': difficulty,
                  'progress': learning_progress,
                  'understanding': understanding_level,
                  'time_spent': time_spent,
                  'sentiment': sentiment
              })
              
              # è¯¾ç¨‹åé¦ˆæ•°æ®
              if course not in course_feedback_data:
                  course_feedback_data[course] = []
              course_feedback_data[course].append({
                  'date': date_key,
                  'difficulty': difficulty,
                  'progress': learning_progress,
                  'understanding': understanding_level,
                  'sentiment': sentiment
              })
              
              # ç»Ÿè®¡å­¦ç”Ÿ
              if student_name not in stats['students']:
                  stats['students'][student_name] = {
                      'name': student_name,
                      'total_feedback': 0,
                      'courses': set(),
                      'avg_difficulty': 0,
                      'total_time_spent': 0,
                      'avg_progress': 0,
                      'avg_understanding': 0,
                      'engagement_score': 0,  # å‚ä¸åº¦è¯„åˆ†
                      'learning_trend': 'stable',  # å­¦ä¹ è¶‹åŠ¿ï¼šrising, stable, declining
                      'at_risk': False
                  }
              
              stats['students'][student_name]['total_feedback'] += 1
              stats['students'][student_name]['courses'].add(course)
              stats['students'][student_name]['total_time_spent'] += time_spent
              stats['students'][student_name]['avg_progress'] += learning_progress
              stats['students'][student_name]['avg_understanding'] += understanding_level
              
              # æ¯æ—¥ç»Ÿè®¡
              if date_key in stats['daily_stats']:
                  stats['daily_stats'][date_key]['count'] += 1
                  stats['daily_stats'][date_key]['difficulty_distribution'][difficulty_key] += 1
              
              # æ¯å‘¨ç»Ÿè®¡
              if week_key in stats['weekly_stats']:
                  stats['weekly_stats'][week_key]['count'] += 1
                  stats['weekly_stats'][week_key]['unique_students'].add(student_name)
              
              # æ¯æœˆç»Ÿè®¡
              if month_key in stats['monthly_stats']:
                  stats['monthly_stats'][month_key]['count'] += 1
                  stats['monthly_stats'][month_key]['unique_students'].add(student_name)
              
              # ä¿å­˜è¯¦æƒ…
              stats['issues_detail'].append({
                  'id': issue.number,
                  'title': issue.title,
                  'course': course,
                  'student': student_name,
                  'difficulty': difficulty,
                  'progress': learning_progress,
                  'understanding': understanding_level,
                  'time_spent': time_spent,
                  'sentiment': sentiment,
                  'created_at': created_at.isoformat(),
                  'state': issue.state
              })
          
          # ========== é«˜çº§åˆ†æ ==========
          
          # 1. è®¡ç®—è¯¾ç¨‹å¹³å‡å€¼
          for course in stats['courses']:
              feedback_count = stats['courses'][course]['total_feedback']
              if feedback_count > 0:
                  stats['courses'][course]['avg_progress'] = round(
                      stats['courses'][course]['avg_progress'] / feedback_count, 2
                  )
                  stats['courses'][course]['avg_understanding'] = round(
                      stats['courses'][course]['avg_understanding'] / feedback_count, 2
                  )
                  stats['courses'][course]['avg_time_spent'] = round(
                      stats['courses'][course]['avg_time_spent'] / feedback_count, 2
                  )
              
              # è®¡ç®—è¯¾ç¨‹æœ‰æ•ˆæ€§è¯„åˆ†
              # è¯„åˆ† = (å¹³å‡ç†è§£ç¨‹åº¦ Ã— 0.4) + (å¹³å‡å­¦ä¹ è¿›åº¦ Ã— 0.3) + (ç§¯ææƒ…æ„Ÿæ¯”ä¾‹ Ã— 0.3)
              total_sentiments = sum(stats['courses'][course]['sentiment_distribution'].values())
              positive_ratio = stats['courses'][course]['sentiment_distribution'].get('ç§¯æ', 0) / max(total_sentiments, 1)
              
              stats['courses'][course]['effectiveness_score'] = round(
                  (stats['courses'][course]['avg_understanding'] * 0.4 +
                   stats['courses'][course]['avg_progress'] / 100 * 0.3 +
                   positive_ratio * 0.3) * 20,  # è½¬æ¢ä¸º100åˆ†åˆ¶
                  1
              )
              
              # æ¸…ç†ä¸´æ—¶set
              if 'students' in stats['courses'][course]:
                  del stats['courses'][course]['students']
          
          # 2. è®¡ç®—å­¦ç”Ÿå¹³å‡å€¼å’Œå‚ä¸åº¦è¯„åˆ†
          for student_name in stats['students']:
              feedback_count = stats['students'][student_name]['total_feedback']
              if feedback_count > 0:
                  stats['students'][student_name]['avg_difficulty'] = round(
                      sum(d['difficulty'] for d in student_learning_data[student_name]) / feedback_count, 2
                  )
                  stats['students'][student_name]['avg_progress'] = round(
                      stats['students'][student_name]['avg_progress'] / feedback_count, 2
                  )
                  stats['students'][student_name]['avg_understanding'] = round(
                      stats['students'][student_name]['avg_understanding'] / feedback_count, 2
                  )
              
              # å‚ä¸åº¦è¯„åˆ†
              # è¯„åˆ† = (åé¦ˆæ¬¡æ•° Ã— 0.3) + (è¯¾ç¨‹æ•°é‡ Ã— 0.2) + (æ€»å­¦ä¹ æ—¶é•¿/100 Ã— 0.3) + (å¹³å‡è¿›åº¦/100 Ã— 0.2)
              course_count = len(stats['students'][student_name]['courses'])
              stats['students'][student_name]['engagement_score'] = round(
                  min(100, 
                      feedback_count * 3 +  # æ¯æ¬¡åé¦ˆ+3åˆ†
                      course_count * 10 +  # æ¯é—¨è¯¾+10åˆ†
                      min(stats['students'][student_name]['total_time_spent'] / 100 * 10, 30) +  # æ—¶é•¿æœ€å¤š30åˆ†
                      stats['students'][student_name]['avg_progress'] * 0.2  # è¿›åº¦æœ€å¤š20åˆ†
                  ),
                  1
              )
              
              # è½¬æ¢coursesä¸ºlist
              stats['students'][student_name]['courses'] = list(stats['students'][student_name]['courses'])
          
          # 3. å­¦ä¹ è½¨è¿¹åˆ†æ
          for student_name, data in student_learning_data.items():
              # æŒ‰æ—¥æœŸæ’åº
              data.sort(key=lambda x: x['date'])
              
              if len(data) >= 2:
                  # æ¯”è¾ƒæœ€è¿‘3æ¬¡å’Œå‰3æ¬¡çš„å¹³å‡ç†è§£ç¨‹åº¦
                  recent_avg = sum(d['understanding'] for d in data[-3:]) / min(3, len(data))
                  early_avg = sum(d['understanding'] for d in data[:3]) / min(3, len(data))
                  
                  if recent_avg > early_avg + 0.5:
                      stats['students'][student_name]['learning_trend'] = 'rising'
                  elif recent_avg < early_avg - 0.5:
                      stats['students'][student_name]['learning_trend'] = 'declining'
                  else:
                      stats['students'][student_name]['learning_trend'] = 'stable'
              
              stats['learning_trajectory'][student_name] = data
          
          # 4. è¯†åˆ«é«˜é£é™©å­¦ç”Ÿ
          for student_name, student in stats['students'].items():
              risk_factors = 0
              
              # å› ç´ 1ï¼šå‚ä¸åº¦è¯„åˆ†ä½
              if student['engagement_score'] < 40:
                  risk_factors += 1
              
              # å› ç´ 2ï¼šå­¦ä¹ è¿›åº¦ä½
              if student['avg_progress'] < 50:
                  risk_factors += 1
              
              # å› ç´ 3ï¼šç†è§£ç¨‹åº¦ä½
              if student['avg_understanding'] < 2.5:
                  risk_factors += 1
              
              # å› ç´ 4ï¼šå­¦ä¹ è¶‹åŠ¿ä¸‹é™
              if student['learning_trend'] == 'declining':
                  risk_factors += 1
              
              # å› ç´ 5ï¼šè¿‘æœŸæœªåé¦ˆï¼ˆè¶…è¿‡7å¤©ï¼‰
              if student_name in student_learning_data:
                  last_feedback = student_learning_data[student_name][-1]['date']
                  days_since_last = (datetime.now() - datetime.strptime(last_feedback, '%Y-%m-%d')).days
                  if days_since_last > 7:
                      risk_factors += 1
              
              student['at_risk'] = risk_factors >= 3
              if student['at_risk']:
                  stats['at_risk_students'].append({
                      'name': student_name,
                      'risk_factors': risk_factors,
                      'engagement_score': student['engagement_score'],
                      'avg_progress': student['avg_progress'],
                      'learning_trend': student['learning_trend']
                  })
          
          # 5. è®¡ç®—æ¯æ—¥å¹³å‡éš¾åº¦
          for date in stats['daily_stats']:
              day_data = stats['daily_stats'][date]
              total = sum(day_data['difficulty_distribution'].values())
              if total > 0:
                  weighted_sum = sum(
                      int(level) * count 
                      for level, count in day_data['difficulty_distribution'].items()
                  )
                  day_data['avg_difficulty'] = round(weighted_sum / total, 2)
          
          # 6. è®¡ç®—æ¯å‘¨å¹³å‡éš¾åº¦å’Œå”¯ä¸€å­¦ç”Ÿæ•°
          for week in stats['weekly_stats']:
              week_data = stats['weekly_stats'][week]
              week_data['unique_students'] = len(week_data['unique_students'])
          
          # 7. è®¡ç®—æ¯æœˆå¹³å‡éš¾åº¦å’Œå”¯ä¸€å­¦ç”Ÿæ•°
          for month in stats['monthly_stats']:
              month_data = stats['monthly_stats'][month]
              month_data['unique_students'] = len(month_data['unique_students'])
          
          # 8. ç”Ÿæˆè¯¾ç¨‹æœ‰æ•ˆæ€§æ’å
          stats['course_effectiveness'] = dict(sorted(
              {course: data['effectiveness_score'] 
               for course, data in stats['courses'].items()}.items(),
              key=lambda x: x[1],
              reverse=True
          ))
          
          # 9. ç”Ÿæˆæƒ…æ„Ÿåˆ†ææ±‡æ€»
          for course, data in stats['courses'].items():
              stats['feedback_sentiment'][course] = data['sentiment_distribution']
          
          # ç”Ÿæˆæ—¶é—´æ¨¡å¼
          for date_key, day_data in stats['daily_stats'].items():
              day_of_week = datetime.strptime(date_key, '%Y-%m-%d').strftime('%A')
              if day_of_week not in stats['time_patterns']:
                  stats['time_patterns'][day_of_week] = {'count': 0, 'avg_difficulty': 0}
              stats['time_patterns'][day_of_week]['count'] += day_data['count']
              stats['time_patterns'][day_of_week]['avg_difficulty'] += day_data['avg_difficulty']
          
          for day in stats['time_patterns']:
              total = sum(stats['time_patterns'][day]['count'] for d in stats['time_patterns'])
              if total > 0:
                  stats['time_patterns'][day]['avg_difficulty'] = round(
                      stats['time_patterns'][day]['avg_difficulty'] / 7, 2  # ç®€åŒ–è®¡ç®—
                  )
          
          # 10. å…³è”æ€§åˆ†æï¼ˆéš¾åº¦ä¸ç†è§£ç¨‹åº¦çš„ç›¸å…³æ€§ï¼‰
          all_difficulties = []
          all_understandings = []
          
          for issue in stats['issues_detail']:
              all_difficulties.append(issue['difficulty'])
              all_understandings.append(issue['understanding'])
          
          if len(all_difficulties) > 1:
              # è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°
              n = len(all_difficulties)
              sum_diff = sum(all_difficulties)
              sum_under = sum(all_understandings)
              sum_diff_sq = sum(d**2 for d in all_difficulties)
              sum_under_sq = sum(u**2 for u in all_understandings)
              sum_prod = sum(d * u for d, u in zip(all_difficulties, all_understandings))
              
              numerator = n * sum_prod - sum_diff * sum_under
              denominator = math.sqrt((n * sum_diff_sq - sum_diff**2) * 
                                     (n * sum_under_sq - sum_under**2))
              
              if denominator != 0:
                  stats['correlation_analysis']['difficulty_understanding'] = round(
                      numerator / denominator, 3
                  )
          
          # ä¿å­˜ç»Ÿè®¡æ•°æ®
          with open('data/stats_enhanced.json', 'w', encoding='utf-8') as f:
              json.dump(stats, f, ensure_ascii=False, indent=2)
          
          print("âœ… å¢å¼ºåˆ†æå®Œæˆï¼")
          print(f"ğŸ“Š æ€»åé¦ˆæ•°: {stats['total_issues']}")
          print(f"ğŸ“š è¯¾ç¨‹æ•°: {len(stats['courses'])}")
          print(f"ğŸ‘¥ å­¦ç”Ÿæ•°: {len(stats['students'])}")
          print(f"âš ï¸  é«˜é£é™©å­¦ç”Ÿ: {len(stats['at_risk_students'])}äºº")
          
          # ç”Ÿæˆå­¦ä¹ é£é™©æŠ¥å‘Š
          if len(stats['at_risk_students']) > 0:
              report = f"# å­¦ä¹ é£é™©é¢„è­¦æŠ¥å‘Š\n\n"
              report += f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
              report += f"## é«˜é£é™©å­¦ç”Ÿåˆ—è¡¨ ({len(stats['at_risk_students'])}äºº)\n\n"
              
              for student in stats['at_risk_students']:
                  report += f"### {student['name']}\n"
                  report += f"- é£é™©å› ç´ æ•°: {student['risk_factors']}\n"
                  report += f"- å‚ä¸åº¦è¯„åˆ†: {student['engagement_score']}/100\n"
                  report += f"- å¹³å‡è¿›åº¦: {student['avg_progress']}%\n"
                  report += f"- å­¦ä¹ è¶‹åŠ¿: {student['learning_trend']}\n\n"
              
              with open('data/reports/risk_alert.md', 'w', encoding='utf-8') as f:
                  f.write(report)
              
              print(f"ğŸ“„ é£é™©æŠ¥å‘Šå·²ç”Ÿæˆ: data/reports/risk_alert.md")
          EOF
      
      - name: æäº¤å¢å¼ºåˆ†ææ–‡ä»¶
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/stats_enhanced.json data/reports/risk_alert.md
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š å¢å¼ºåˆ†æå®Œæˆ [è‡ªåŠ¨è¿è¡Œ]"
          git push
