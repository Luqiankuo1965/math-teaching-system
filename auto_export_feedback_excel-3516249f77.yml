name: è‡ªåŠ¨å¯¼å‡ºåé¦ˆæ•°æ®åˆ°Excelï¼ˆå¢å¼ºç‰ˆï¼‰

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # 2. äº‹ä»¶è§¦å‘ï¼šæœ‰æ–°åé¦ˆIssueæäº¤æ—¶
  issues:
    types: [opened, edited, reopened]
  
  # 3. æ‰‹åŠ¨è§¦å‘ï¼šéšæ—¶å¯ä»¥æŒ‰éœ€å¯¼å‡º
  workflow_dispatch:
    inputs:
      date_range:
        description: 'æ—¥æœŸèŒƒå›´ï¼ˆå¤©æ•°ï¼‰'
        required: false
        type: choice
        options:
          - 7å¤©
          - 30å¤©
          - 90å¤©
          - 180å¤©
          - å…¨éƒ¨
        default: '30å¤©'
      include_closed:
        description: 'åŒ…å«å·²å…³é—­çš„åé¦ˆ'
        required: false
        type: boolean
        default: true
      generate_summary:
        description: 'ç”Ÿæˆæ•°æ®æ‘˜è¦'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  export_excel:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install pygithub requests pandas openpyxl
      
      - name: æ¸…ç†æ—§ç‰ˆæœ¬Excelæ–‡ä»¶
        run: |
          # ä¿ç•™æœ€è¿‘7å¤©çš„Excelæ–‡ä»¶ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬
          if [ -d "data/excel" ]; then
            find data/excel/ -name "*.xlsx" -type f -mtime +7 -delete
            find data/excel/ -name "metadata_*.json" -type f -mtime +7 -delete
            echo "âœ… å·²æ¸…ç†7å¤©å‰çš„æ—§ç‰ˆæœ¬æ–‡ä»¶"
          fi
      
      - name: è¿è¡ŒExcelå¯¼å‡ºè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DATE_RANGE: ${{ github.event.inputs.date_range || '30å¤©' }}
          INCLUDE_CLOSED: ${{ github.event.inputs.include_closed || 'true' }}
          GENERATE_SUMMARY: ${{ github.event.inputs.generate_summary || 'true' }}
          TRIGGER_TYPE: ${{ github.event_name }}
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from github import Github
          import pandas as pd
          
          # åˆå§‹åŒ–GitHubå®¢æˆ·ç«¯
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          date_range_str = os.environ.get('DATE_RANGE', '30å¤©')
          include_closed = os.environ.get('INCLUDE_CLOSED', 'true').lower() == 'true'
          generate_summary = os.environ.get('GENERATE_SUMMARY', 'true').lower() == 'true'
          trigger_type = os.environ.get('TRIGGER_TYPE', 'manual')
          
          g = Github(token)
          repo = g.get_repo(repo_name)
          
          trigger_labels = {
              'schedule': 'å®šæ—¶è§¦å‘',
              'issues': 'äº‹ä»¶è§¦å‘',
              'workflow_dispatch': 'æ‰‹åŠ¨è§¦å‘'
          }
          
          print(f"ğŸ“Š å¼€å§‹å¯¼å‡ºåé¦ˆæ•°æ®åˆ°Excel...")
          print(f"ğŸ“‚ ä»“åº“ï¼š{repo_name}")
          print(f"âš¡ è§¦å‘æ–¹å¼ï¼š{trigger_labels.get(trigger_type, 'æœªçŸ¥')}")
          print(f"ğŸ“… æ—¥æœŸèŒƒå›´ï¼š{date_range_str}")
          print(f"ğŸ” åŒ…å«å·²å…³é—­åé¦ˆï¼š{include_closed}")
          
          # è§£ææ—¥æœŸèŒƒå›´
          date_map = {
              '7å¤©': 7,
              '30å¤©': 30,
              '90å¤©': 90,
              '180å¤©': 180,
              'å…¨éƒ¨': None
          }
          days = date_map.get(date_range_str)
          
          # è®¡ç®—æˆªæ­¢æ—¥æœŸ
          if days:
              cutoff_date = datetime.now() - timedelta(days=days)
              print(f"ğŸ“… èµ·å§‹æ—¥æœŸï¼š{cutoff_date.strftime('%Y-%m-%d')}")
          
          # è·å–æ‰€æœ‰åé¦ˆIssues
          print("ğŸ” è·å–åé¦ˆIssues...")
          issues = repo.get_issues(state='all')
          
          # å‡†å¤‡æ•°æ®ç»“æ„
          feedback_data = []
          course_stats = {}
          student_stats = {}
          
          # éå†Issues
          for issue in issues:
              # è·³è¿‡éåé¦ˆIssue
              if not any(label.name == 'åé¦ˆ' for label in issue.labels):
                  continue
              
              # è¿‡æ»¤æ—¥æœŸ
              if days and issue.created_at.replace(tzinfo=None) < cutoff_date:
                  continue
              
              # è¿‡æ»¤å·²å…³é—­çš„åé¦ˆ
              if not include_closed and issue.state == 'closed':
                  continue
              
              # è§£æIssueå†…å®¹
              body = issue.body or ''
              created_at = issue.created_at
              updated_at = issue.updated_at
              
              # æå–ä¿¡æ¯
              course = 'æœªçŸ¥è¯¾ç¨‹'
              chapter = 'æœªçŸ¥ç« èŠ‚'
              student_name = 'åŒ¿åå­¦ç”Ÿ'
              student_id = ''
              difficulty = 3
              feedback_type = 'è¯¾ç¨‹åé¦ˆ'
              
              # è§£æå­—æ®µ
              for line in body.split('\n'):
                  line = line.strip()
                  if 'è¯¾ç¨‹åç§°' in line or 'è¯¾ç¨‹' in line:
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              course = parts[-1].strip()
                  elif 'ç« èŠ‚' in line or 'Chapter' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              chapter = parts[-1].strip()
                  elif 'å§“å' in line or 'å­¦ç”Ÿ' in line or 'Name' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              student_name = parts[-1].strip()
                  elif 'å­¦å·' in line or 'ID' in line:
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              student_id = parts[-1].strip()
                  elif 'éš¾åº¦' in line or 'Difficulty' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              try:
                                  difficulty = int(parts[-1].strip().replace('åˆ†', ''))
                                  difficulty = max(1, min(5, difficulty))
                              except:
                                  difficulty = 3
                  elif 'åé¦ˆç±»å‹' in line or 'Type' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              feedback_type = parts[-1].strip()
              
              # éš¾åº¦ç­‰çº§æ ‡ç­¾
              difficulty_labels = {1: 'å®¹æ˜“', 2: 'ä¸€èˆ¬', 3: 'å›°éš¾', 4: 'éå¸¸å›°éš¾', 5: 'æéš¾'}
              
              # æ„å»ºåé¦ˆè®°å½•
              record = {
                  'Issueç¼–å·': issue.number,
                  'æ ‡é¢˜': issue.title,
                  'è¯¾ç¨‹åç§°': course,
                  'ç« èŠ‚': chapter,
                  'å­¦ç”Ÿå§“å': student_name,
                  'å­¦å·': student_id,
                  'åé¦ˆç±»å‹': feedback_type,
                  'éš¾åº¦è¯„åˆ†': difficulty,
                  'éš¾åº¦ç­‰çº§': difficulty_labels.get(difficulty, 'å›°éš¾'),
                  'åé¦ˆå†…å®¹': body,
                  'çŠ¶æ€': issue.state,
                  'åˆ›å»ºæ—¶é—´': created_at.strftime('%Y-%m-%d %H:%M:%S'),
                  'æœ€åæ›´æ–°': updated_at.strftime('%Y-%m-%d %H:%M:%S'),
                  'GitHubé“¾æ¥': issue.html_url
              }
              
              feedback_data.append(record)
              
              # ç»Ÿè®¡è¯¾ç¨‹æ•°æ®
              if course not in course_stats:
                  course_stats[course] = {
                      'åé¦ˆæ•°': 0,
                      'å¹³å‡éš¾åº¦': 0,
                      'å­¦ç”Ÿæ•°': set(),
                      'éš¾åº¦åˆ†å¸ƒ': {'å®¹æ˜“': 0, 'ä¸€èˆ¬': 0, 'å›°éš¾': 0, 'éå¸¸å›°éš¾': 0, 'æéš¾': 0}
                  }
              
              course_stats[course]['åé¦ˆæ•°'] += 1
              course_stats[course]['å­¦ç”Ÿæ•°'].add(student_name)
              course_stats[course]['éš¾åº¦åˆ†å¸ƒ'][difficulty_labels.get(difficulty, 'å›°éš¾')] += 1
              
              # ç»Ÿè®¡å­¦ç”Ÿæ•°æ®
              student_key = f"{student_name}_{student_id}" if student_id else student_name
              if student_key not in student_stats:
                  student_stats[student_key] = {
                      'å§“å': student_name,
                      'å­¦å·': student_id,
                      'åé¦ˆæ¬¡æ•°': 0,
                      'å¹³å‡éš¾åº¦': 0,
                      'éš¾åº¦åˆ—è¡¨': []
                  }
              
              student_stats[student_key]['åé¦ˆæ¬¡æ•°'] += 1
              student_stats[student_key]['éš¾åº¦åˆ—è¡¨'].append(difficulty)
          
          # è®¡ç®—å¹³å‡éš¾åº¦
          for course in course_stats:
              stats = course_stats[course]
              if stats['åé¦ˆæ•°'] > 0:
                  total_difficulty = sum([
                      (1 * stats['éš¾åº¦åˆ†å¸ƒ']['å®¹æ˜“']) +
                      (2 * stats['éš¾åº¦åˆ†å¸ƒ']['ä¸€èˆ¬']) +
                      (3 * stats['éš¾åº¦åˆ†å¸ƒ']['å›°éš¾']) +
                      (4 * stats['éš¾åº¦åˆ†å¸ƒ']['éå¸¸å›°éš¾']) +
                      (5 * stats['éš¾åº¦åˆ†å¸ƒ']['æéš¾'])
                  ])
                  stats['å¹³å‡éš¾åº¦'] = round(total_difficulty / stats['åé¦ˆæ•°'], 2)
              stats['å­¦ç”Ÿæ•°'] = len(stats['å­¦ç”Ÿæ•°'])
          
          for student_key in student_stats:
              stats = student_stats[student_key]
              if stats['éš¾åº¦åˆ—è¡¨']:
                  stats['å¹³å‡éš¾åº¦'] = round(sum(stats['éš¾åº¦åˆ—è¡¨']) / len(stats['éš¾åº¦åˆ—è¡¨']), 2)
              del stats['éš¾åº¦åˆ—è¡¨']
          
          # ç”ŸæˆExcelæ–‡ä»¶
          if feedback_data:
              timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
              output_dir = 'data/excel'
              os.makedirs(output_dir, exist_ok=True)
              
              # 1. åˆ›å»ºåé¦ˆæ˜ç»†è¡¨
              print("ğŸ“ ç”Ÿæˆåé¦ˆæ˜ç»†è¡¨...")
              df_feedback = pd.DataFrame(feedback_data)
              df_feedback = df_feedback.sort_values(by='åˆ›å»ºæ—¶é—´', ascending=False)
              
              # 2. åˆ›å»ºè¯¾ç¨‹ç»Ÿè®¡è¡¨
              print("ğŸ“š ç”Ÿæˆè¯¾ç¨‹ç»Ÿè®¡è¡¨...")
              course_data = []
              for course, stats in course_stats.items():
                  course_data.append({
                      'è¯¾ç¨‹åç§°': course,
                      'åé¦ˆæ€»æ•°': stats['åé¦ˆæ•°'],
                      'å‚ä¸å­¦ç”Ÿæ•°': stats['å­¦ç”Ÿæ•°'],
                      'å¹³å‡éš¾åº¦': stats['å¹³å‡éš¾åº¦'],
                      'å®¹æ˜“ï¼ˆ1åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['å®¹æ˜“'],
                      'ä¸€èˆ¬ï¼ˆ2åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['ä¸€èˆ¬'],
                      'å›°éš¾ï¼ˆ3åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['å›°éš¾'],
                      'éå¸¸å›°éš¾ï¼ˆ4åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['éå¸¸å›°éš¾'],
                      'æéš¾ï¼ˆ5åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['æéš¾']
                  })
              
              df_course = pd.DataFrame(course_data)
              df_course = df_course.sort_values(by='åé¦ˆæ€»æ•°', ascending=False)
              
              # 3. åˆ›å»ºå­¦ç”Ÿç»Ÿè®¡è¡¨
              print("ğŸ‘¥ ç”Ÿæˆå­¦ç”Ÿç»Ÿè®¡è¡¨...")
              student_data = []
              for student_key, stats in student_stats.items():
                  student_data.append({
                      'å­¦ç”Ÿå§“å': stats['å§“å'],
                      'å­¦å·': stats['å­¦å·'],
                      'åé¦ˆæ¬¡æ•°': stats['åé¦ˆæ¬¡æ•°'],
                      'å¹³å‡éš¾åº¦': stats['å¹³å‡éš¾åº¦']
                  })
              
              df_student = pd.DataFrame(student_data)
              df_student = df_student.sort_values(by='åé¦ˆæ¬¡æ•°', ascending=False)
              
              # 4. ç”Ÿæˆæ¯æ—¥è¶‹åŠ¿æ•°æ®
              print("ğŸ“ˆ ç”Ÿæˆæ¯æ—¥è¶‹åŠ¿è¡¨...")
              daily_trends = {}
              for record in feedback_data:
                  date = record['åˆ›å»ºæ—¶é—´'].split(' ')[0]
                  if date not in daily_trends:
                      daily_trends[date] = {'åé¦ˆæ•°': 0, 'æ€»éš¾åº¦': 0, 'è®¡æ•°': 0}
                  
                  daily_trends[date]['åé¦ˆæ•°'] += 1
                  daily_trends[date]['æ€»éš¾åº¦'] += record['éš¾åº¦è¯„åˆ†']
                  daily_trends[date]['è®¡æ•°'] += 1
              
              trend_data = []
              for date in sorted(daily_trends.keys(), reverse=True):
                  trends = daily_trends[date]
                  avg_difficulty = round(trends['æ€»éš¾åº¦'] / trends['è®¡æ•°'], 2) if trends['è®¡æ•°'] > 0 else 0
                  trend_data.append({
                      'æ—¥æœŸ': date,
                      'åé¦ˆæ•°é‡': trends['åé¦ˆæ•°'],
                      'å¹³å‡éš¾åº¦': avg_difficulty
                  })
              
              df_trend = pd.DataFrame(trend_data)
              
              # 5. åˆ›å»ºExcelæ–‡ä»¶
              print("ğŸ“Š ç”ŸæˆExcelæ–‡ä»¶...")
              excel_filename = f'åé¦ˆæ•°æ®æŠ¥è¡¨_{timestamp}.xlsx'
              excel_path = os.path.join(output_dir, excel_filename)
              
              with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
                  df_feedback.to_excel(writer, sheet_name='åé¦ˆæ˜ç»†', index=False)
                  df_course.to_excel(writer, sheet_name='è¯¾ç¨‹ç»Ÿè®¡', index=False)
                  df_student.to_excel(writer, sheet_name='å­¦ç”Ÿç»Ÿè®¡', index=False)
                  df_trend.to_excel(writer, sheet_name='æ¯æ—¥è¶‹åŠ¿', index=False)
              
              # 6. ç”Ÿæˆæ•°æ®æ‘˜è¦
              if generate_summary:
                  print("ğŸ“‹ ç”Ÿæˆæ•°æ®æ‘˜è¦...")
                  summary = {
                      'å¯¼å‡ºæ—¶é—´': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                      'è§¦å‘æ–¹å¼': trigger_labels.get(trigger_type, 'æœªçŸ¥'),
                      'æ•°æ®èŒƒå›´': date_range_str,
                      'ç»Ÿè®¡ä¿¡æ¯': {
                          'åé¦ˆæ€»æ•°': len(feedback_data),
                          'è¯¾ç¨‹æ•°é‡': len(course_stats),
                          'å­¦ç”Ÿæ•°é‡': len(student_stats),
                          'æ—¶é—´è·¨åº¦': len(trend_data)
                      },
                      'çƒ­é—¨è¯¾ç¨‹': [
                          {'è¯¾ç¨‹': k, 'åé¦ˆæ•°': v['åé¦ˆæ•°']} 
                          for k, v in sorted(course_stats.items(), key=lambda x: x[1]['åé¦ˆæ•°'], reverse=True)[:5]
                      ],
                      'æ´»è·ƒå­¦ç”Ÿ': [
                          {'å­¦ç”Ÿ': v['å§“å'], 'åé¦ˆæ•°': v['åé¦ˆæ¬¡æ•°']}
                          for k, v in sorted(student_stats.items(), key=lambda x: x[1]['åé¦ˆæ¬¡æ•°'], reverse=True)[:5]
                      ]
                  }
                  
                  summary_path = os.path.join(output_dir, f'æ‘˜è¦_{timestamp}.json')
                  with open(summary_path, 'w', encoding='utf-8') as f:
                      json.dump(summary, f, ensure_ascii=False, indent=2)
              
              # 7. ä¿å­˜å…ƒæ•°æ®
              metadata = {
                  'export_time': datetime.now().isoformat(),
                  'file_path': excel_path,
                  'filename': excel_filename,
                  'trigger_type': trigger_type,
                  'parameters': {
                      'date_range': date_range_str,
                      'include_closed': include_closed
                  },
                  'statistics': {
                      'total_feedback': len(feedback_data),
                      'courses_count': len(course_stats),
                      'students_count': len(student_stats),
                      'days_span': len(trend_data)
                  }
              }
              
              metadata_path = os.path.join(output_dir, f'metadata_{timestamp}.json')
              with open(metadata_path, 'w', encoding='utf-8') as f:
                  json.dump(metadata, f, ensure_ascii=False, indent=2)
              
              # 8. ç”Ÿæˆæœ€æ–°ç‰ˆæœ¬é“¾æ¥
              latest_path = os.path.join(output_dir, 'LATEST.txt')
              with open(latest_path, 'w', encoding='utf-8') as f:
                  f.write(f"{excel_filename}\n")
                  f.write(f"{metadata_path}\n")
              print(f"âœ… Excelæ–‡ä»¶å·²ç”Ÿæˆï¼š{excel_path}")
              print(f"ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š")
              print(f"   - åé¦ˆæ€»æ•°ï¼š{len(feedback_data)}")
              print(f"   - è¯¾ç¨‹æ•°é‡ï¼š{len(course_stats)}")
              print(f"   - å­¦ç”Ÿæ•°é‡ï¼š{len(student_stats)}")
              print(f"   - æ—¶é—´è·¨åº¦ï¼š{len(trend_data)}å¤©")
              
          else:
              print("âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®")
          
          EOF
      
      - name: æäº¤Excelæ–‡ä»¶åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/excel/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š è‡ªåŠ¨å¯¼å‡ºåé¦ˆæ•°æ®Excel [${{ github.event_name }}]"
          git push
      
      - name: ç”Ÿæˆå·¥ä½œæµæ€»ç»“
        if: always()
        run: |
          echo "ğŸ“Š åé¦ˆæ•°æ®Excelè‡ªåŠ¨å¯¼å‡ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**ï¼š${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæœ€æ–°Excelæ–‡ä»¶ä¿¡æ¯
          if [ -f "data/excel/LATEST.txt" ]; then
            latest_file=$(head -1 data/excel/LATEST.txt)
            echo "**æœ€æ–°Excelæ–‡ä»¶**ï¼š\`$latest_file\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ä¸‹è½½è·¯å¾„**ï¼š\`data/excel/$latest_file\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ˜¾ç¤ºå†å²ç‰ˆæœ¬
          if [ -d "data/excel" ]; then
            echo "**å†å²ç‰ˆæœ¬**ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            ls -th data/excel/*.xlsx 2>/dev/null | head -7 | while read file; do
              filename=$(basename "$file")
              file_date=$(stat -c %y "$file" | cut -d' ' -f1)
              echo "- \`${filename}\` ($file_date)" >> $GITHUB_STEP_SUMMARY
            done
          fi
