name: å¯¼å‡ºåé¦ˆæ•°æ®åˆ°Excel

on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'æ—¥æœŸèŒƒå›´ï¼ˆå¤©æ•°ï¼‰'
        required: false
        type: choice
        options:
          - 7å¤©
          - 30å¤©
          - 90å¤©
          - 180å¤©
          - å…¨éƒ¨
        default: '30å¤©'
      include_closed:
        description: 'åŒ…å«å·²å…³é—­çš„åé¦ˆ'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  export_excel:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install pygithub requests pandas openpyxl
      
      - name: è¿è¡ŒExcelå¯¼å‡ºè„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DATE_RANGE: ${{ github.event.inputs.date_range }}
          INCLUDE_CLOSED: ${{ github.event.inputs.include_closed }}
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta
          from github import Github
          import pandas as pd
          
          # åˆå§‹åŒ–GitHubå®¢æˆ·ç«¯
          token = os.environ['GITHUB_TOKEN']
          repo_name = os.environ['GITHUB_REPOSITORY']
          date_range_str = os.environ.get('DATE_RANGE', '30å¤©')
          include_closed = os.environ.get('INCLUDE_CLOSED', 'true').lower() == 'true'
          
          g = Github(token)
          repo = g.get_repo(repo_name)
          
          print(f"ğŸ“Š å¼€å§‹å¯¼å‡ºåé¦ˆæ•°æ®åˆ°Excel...")
          print(f"ğŸ“‚ ä»“åº“ï¼š{repo_name}")
          print(f"ğŸ“… æ—¥æœŸèŒƒå›´ï¼š{date_range_str}")
          print(f"ğŸ” åŒ…å«å·²å…³é—­åé¦ˆï¼š{include_closed}")
          
          # è§£ææ—¥æœŸèŒƒå›´
          date_map = {
              '7å¤©': 7,
              '30å¤©': 30,
              '90å¤©': 90,
              '180å¤©': 180,
              'å…¨éƒ¨': None
          }
          days = date_map.get(date_range_str)
          
          # è®¡ç®—æˆªæ­¢æ—¥æœŸ
          if days:
              cutoff_date = datetime.now() - timedelta(days=days)
              print(f"ğŸ“… èµ·å§‹æ—¥æœŸï¼š{cutoff_date.strftime('%Y-%m-%d')}")
          
          # è·å–æ‰€æœ‰åé¦ˆIssues
          print("ğŸ” è·å–åé¦ˆIssues...")
          issues = repo.get_issues(state='all')
          
          # å‡†å¤‡æ•°æ®ç»“æ„
          feedback_data = []
          course_stats = {}
          student_stats = {}
          
          # éå†Issues
          for issue in issues:
              # è·³è¿‡éåé¦ˆIssue
              if not any(label.name == 'åé¦ˆ' for label in issue.labels):
                  continue
              
              # è¿‡æ»¤æ—¥æœŸ
              if days and issue.created_at.replace(tzinfo=None) < cutoff_date:
                  continue
              
              # è¿‡æ»¤å·²å…³é—­çš„åé¦ˆ
              if not include_closed and issue.state == 'closed':
                  continue
              
              # è§£æIssueå†…å®¹
              body = issue.body or ''
              created_at = issue.created_at
              updated_at = issue.updated_at
              
              # æå–ä¿¡æ¯
              course = 'æœªçŸ¥è¯¾ç¨‹'
              chapter = 'æœªçŸ¥ç« èŠ‚'
              student_name = 'åŒ¿åå­¦ç”Ÿ'
              student_id = ''
              difficulty = 3
              feedback_type = 'è¯¾ç¨‹åé¦ˆ'
              
              # è§£æå­—æ®µ
              for line in body.split('\n'):
                  line = line.strip()
                  if 'è¯¾ç¨‹åç§°' in line or 'è¯¾ç¨‹' in line:
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              course = parts[-1].strip()
                  elif 'ç« èŠ‚' in line or 'Chapter' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              chapter = parts[-1].strip()
                  elif 'å§“å' in line or 'å­¦ç”Ÿ' in line or 'Name' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              student_name = parts[-1].strip()
                  elif 'å­¦å·' in line or 'ID' in line:
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              student_id = parts[-1].strip()
                  elif 'éš¾åº¦' in line or 'Difficulty' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              try:
                                  difficulty = int(parts[-1].strip().replace('åˆ†', ''))
                                  difficulty = max(1, min(5, difficulty))
                              except:
                                  difficulty = 3
                  elif 'åé¦ˆç±»å‹' in line or 'Type' in line.lower():
                      if 'ï¼š' in line or ':' in line:
                          parts = line.split('ï¼š') if 'ï¼š' in line else line.split(':')
                          if len(parts) > 1:
                              feedback_type = parts[-1].strip()
              
              # éš¾åº¦ç­‰çº§æ ‡ç­¾
              difficulty_labels = {1: 'å®¹æ˜“', 2: 'ä¸€èˆ¬', 3: 'å›°éš¾', 4: 'éå¸¸å›°éš¾', 5: 'æéš¾'}
              
              # æ„å»ºåé¦ˆè®°å½•
              record = {
                  'Issueç¼–å·': issue.number,
                  'æ ‡é¢˜': issue.title,
                  'è¯¾ç¨‹åç§°': course,
                  'ç« èŠ‚': chapter,
                  'å­¦ç”Ÿå§“å': student_name,
                  'å­¦å·': student_id,
                  'åé¦ˆç±»å‹': feedback_type,
                  'éš¾åº¦è¯„åˆ†': difficulty,
                  'éš¾åº¦ç­‰çº§': difficulty_labels.get(difficulty, 'å›°éš¾'),
                  'åé¦ˆå†…å®¹': body,
                  'çŠ¶æ€': issue.state,
                  'åˆ›å»ºæ—¶é—´': created_at.strftime('%Y-%m-%d %H:%M:%S'),
                  'æœ€åæ›´æ–°': updated_at.strftime('%Y-%m-%d %H:%M:%S'),
                  'GitHubé“¾æ¥': issue.html_url
              }
              
              feedback_data.append(record)
              
              # ç»Ÿè®¡è¯¾ç¨‹æ•°æ®
              if course not in course_stats:
                  course_stats[course] = {
                      'åé¦ˆæ•°': 0,
                      'å¹³å‡éš¾åº¦': 0,
                      'å­¦ç”Ÿæ•°': set(),
                      'éš¾åº¦åˆ†å¸ƒ': {'å®¹æ˜“': 0, 'ä¸€èˆ¬': 0, 'å›°éš¾': 0, 'éå¸¸å›°éš¾': 0, 'æéš¾': 0}
                  }
              
              course_stats[course]['åé¦ˆæ•°'] += 1
              course_stats[course]['å­¦ç”Ÿæ•°'].add(student_name)
              course_stats[course]['éš¾åº¦åˆ†å¸ƒ'][difficulty_labels.get(difficulty, 'å›°éš¾')] += 1
              
              # ç»Ÿè®¡å­¦ç”Ÿæ•°æ®
              student_key = f"{student_name}_{student_id}" if student_id else student_name
              if student_key not in student_stats:
                  student_stats[student_key] = {
                      'å§“å': student_name,
                      'å­¦å·': student_id,
                      'åé¦ˆæ¬¡æ•°': 0,
                      'å¹³å‡éš¾åº¦': 0,
                      'éš¾åº¦åˆ—è¡¨': []
                  }
              
              student_stats[student_key]['åé¦ˆæ¬¡æ•°'] += 1
              student_stats[student_key]['éš¾åº¦åˆ—è¡¨'].append(difficulty)
          
          # è®¡ç®—å¹³å‡éš¾åº¦
          for course in course_stats:
              stats = course_stats[course]
              if stats['åé¦ˆæ•°'] > 0:
                  total_difficulty = sum([
                      (1 * stats['éš¾åº¦åˆ†å¸ƒ']['å®¹æ˜“']) +
                      (2 * stats['éš¾åº¦åˆ†å¸ƒ']['ä¸€èˆ¬']) +
                      (3 * stats['éš¾åº¦åˆ†å¸ƒ']['å›°éš¾']) +
                      (4 * stats['éš¾åº¦åˆ†å¸ƒ']['éå¸¸å›°éš¾']) +
                      (5 * stats['éš¾åº¦åˆ†å¸ƒ']['æéš¾'])
                  ])
                  stats['å¹³å‡éš¾åº¦'] = round(total_difficulty / stats['åé¦ˆæ•°'], 2)
              stats['å­¦ç”Ÿæ•°'] = len(stats['å­¦ç”Ÿæ•°'])
          
          for student_key in student_stats:
              stats = student_stats[student_key]
              if stats['éš¾åº¦åˆ—è¡¨']:
                  stats['å¹³å‡éš¾åº¦'] = round(sum(stats['éš¾åº¦åˆ—è¡¨']) / len(stats['éš¾åº¦åˆ—è¡¨']), 2)
              del stats['éš¾åº¦åˆ—è¡¨']
          
          # ç”ŸæˆExcelæ–‡ä»¶
          if feedback_data:
              timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
              output_dir = 'data/excel'
              os.makedirs(output_dir, exist_ok=True)
              
              # 1. åˆ›å»ºåé¦ˆæ˜ç»†è¡¨
              print("ğŸ“ ç”Ÿæˆåé¦ˆæ˜ç»†è¡¨...")
              df_feedback = pd.DataFrame(feedback_data)
              df_feedback = df_feedback.sort_values(by='åˆ›å»ºæ—¶é—´', ascending=False)
              
              # 2. åˆ›å»ºè¯¾ç¨‹ç»Ÿè®¡è¡¨
              print("ğŸ“š ç”Ÿæˆè¯¾ç¨‹ç»Ÿè®¡è¡¨...")
              course_data = []
              for course, stats in course_stats.items():
                  course_data.append({
                      'è¯¾ç¨‹åç§°': course,
                      'åé¦ˆæ€»æ•°': stats['åé¦ˆæ•°'],
                      'å‚ä¸å­¦ç”Ÿæ•°': stats['å­¦ç”Ÿæ•°'],
                      'å¹³å‡éš¾åº¦': stats['å¹³å‡éš¾åº¦'],
                      'å®¹æ˜“ï¼ˆ1åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['å®¹æ˜“'],
                      'ä¸€èˆ¬ï¼ˆ2åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['ä¸€èˆ¬'],
                      'å›°éš¾ï¼ˆ3åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['å›°éš¾'],
                      'éå¸¸å›°éš¾ï¼ˆ4åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['éå¸¸å›°éš¾'],
                      'æéš¾ï¼ˆ5åˆ†ï¼‰': stats['éš¾åº¦åˆ†å¸ƒ']['æéš¾']
                  })
              
              df_course = pd.DataFrame(course_data)
              df_course = df_course.sort_values(by='åé¦ˆæ€»æ•°', ascending=False)
              
              # 3. åˆ›å»ºå­¦ç”Ÿç»Ÿè®¡è¡¨
              print("ğŸ‘¥ ç”Ÿæˆå­¦ç”Ÿç»Ÿè®¡è¡¨...")
              student_data = []
              for student_key, stats in student_stats.items():
                  student_data.append({
                      'å­¦ç”Ÿå§“å': stats['å§“å'],
                      'å­¦å·': stats['å­¦å·'],
                      'åé¦ˆæ¬¡æ•°': stats['åé¦ˆæ¬¡æ•°'],
                      'å¹³å‡éš¾åº¦': stats['å¹³å‡éš¾åº¦']
                  })
              
              df_student = pd.DataFrame(student_data)
              df_student = df_student.sort_values(by='åé¦ˆæ¬¡æ•°', ascending=False)
              
              # 4. ç”Ÿæˆæ¯æ—¥è¶‹åŠ¿æ•°æ®
              print("ğŸ“ˆ ç”Ÿæˆæ¯æ—¥è¶‹åŠ¿è¡¨...")
              daily_trends = {}
              for record in feedback_data:
                  date = record['åˆ›å»ºæ—¶é—´'].split(' ')[0]
                  if date not in daily_trends:
                      daily_trends[date] = {'åé¦ˆæ•°': 0, 'æ€»éš¾åº¦': 0, 'è®¡æ•°': 0}
                  
                  daily_trends[date]['åé¦ˆæ•°'] += 1
                  daily_trends[date]['æ€»éš¾åº¦'] += record['éš¾åº¦è¯„åˆ†']
                  daily_trends[date]['è®¡æ•°'] += 1
              
              trend_data = []
              for date in sorted(daily_trends.keys(), reverse=True):
                  trends = daily_trends[date]
                  avg_difficulty = round(trends['æ€»éš¾åº¦'] / trends['è®¡æ•°'], 2) if trends['è®¡æ•°'] > 0 else 0
                  trend_data.append({
                      'æ—¥æœŸ': date,
                      'åé¦ˆæ•°é‡': trends['åé¦ˆæ•°'],
                      'å¹³å‡éš¾åº¦': avg_difficulty
                  })
              
              df_trend = pd.DataFrame(trend_data)
              
              # 5. åˆ›å»ºExcelæ–‡ä»¶
              print("ğŸ“Š ç”ŸæˆExcelæ–‡ä»¶...")
              excel_path = os.path.join(output_dir, f'åé¦ˆæ•°æ®æŠ¥è¡¨_{timestamp}.xlsx')
              
              with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
                  df_feedback.to_excel(writer, sheet_name='åé¦ˆæ˜ç»†', index=False)
                  df_course.to_excel(writer, sheet_name='è¯¾ç¨‹ç»Ÿè®¡', index=False)
                  df_student.to_excel(writer, sheet_name='å­¦ç”Ÿç»Ÿè®¡', index=False)
                  df_trend.to_excel(writer, sheet_name='æ¯æ—¥è¶‹åŠ¿', index=False)
              
              print(f"âœ… Excelæ–‡ä»¶å·²ç”Ÿæˆï¼š{excel_path}")
              print(f"ğŸ“Š æ•°æ®ç»Ÿè®¡ï¼š")
              print(f"   - åé¦ˆæ€»æ•°ï¼š{len(feedback_data)}")
              print(f"   - è¯¾ç¨‹æ•°é‡ï¼š{len(course_stats)}")
              print(f"   - å­¦ç”Ÿæ•°é‡ï¼š{len(student_stats)}")
              print(f"   - æ—¶é—´è·¨åº¦ï¼š{len(trend_data)}å¤©")
              
              # ä¿å­˜å…ƒæ•°æ®
              metadata = {
                  'export_time': datetime.now().isoformat(),
                  'file_path': excel_path,
                  'parameters': {
                      'date_range': date_range_str,
                      'include_closed': include_closed
                  },
                  'statistics': {
                      'total_feedback': len(feedback_data),
                      'courses_count': len(course_stats),
                      'students_count': len(student_stats),
                      'days_span': len(trend_data)
                  }
              }
              
              with open(f'{output_dir}/metadata_{timestamp}.json', 'w', encoding='utf-8') as f:
                  json.dump(metadata, f, ensure_ascii=False, indent=2)
              
          else:
              print("âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®")
          
          EOF
      
      - name: æäº¤Excelæ–‡ä»¶
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/excel/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š å¯¼å‡ºåé¦ˆæ•°æ®Excel [${{ github.event.inputs.date_range }}]"
          git push
      
      - name: ç”Ÿæˆä¸‹è½½é“¾æ¥
        run: |
          echo "ğŸ“¥ Excelæ–‡ä»¶ä¸‹è½½åœ°å€ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "data/excel" ]; then
              for file in $(ls -t data/excel/*.xlsx | head -1); do
                  filename=$(basename "$file")
                  echo "ğŸ“„ **$filename**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ä¸‹è½½è·¯å¾„ï¼š\`data/excel/$filename\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
              done
          fi
